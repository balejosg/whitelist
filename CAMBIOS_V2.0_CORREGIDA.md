# Correcciones Cr√≠ticas v2.0 - Resumen de Cambios

**Fecha:** 2025-10-25
**Versi√≥n:** v2.0 CORREGIDA

---

## üö® Problemas Cr√≠ticos Solucionados

### 1. DNS Sinkhole Incompleto ‚Üí SOLUCIONADO ‚úÖ

**Problema:**
- El script solo configuraba `server=/domain/gateway` para dominios whitelisted
- No bloqueaba expl√≠citamente dominios NO en whitelist
- Comentario err√≥neo dec√≠a no usar `address=/#/`

**Soluci√≥n:**
- A√±adida directiva `address=/#/127.0.0.1` para bloquear dominios no-whitelist
- Corregido comentario explicando que `address=` NO sobrescribe `server=`
- **Archivo:** setup-dnsmasq-whitelist.sh l√≠neas 394-398

---

### 2. Firewall Permit√≠a HTTP/HTTPS a CUALQUIER IP ‚Üí SOLUCIONADO ‚úÖ

**Problema (CR√çTICO):**
```bash
# ANTES (INSEGURO):
iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT
```
Esto permit√≠a conexiones HTTP/HTTPS a cualquier destino sin validaci√≥n.

**Soluci√≥n:**
```bash
# DESPU√âS (SEGURO):
iptables -A OUTPUT -p tcp --dport 80 -m set --match-set url_whitelist dst -j ACCEPT
iptables -A OUTPUT -p tcp --dport 443 -m set --match-set url_whitelist dst -j ACCEPT
```
Ahora valida que la IP destino est√© en ipset antes de permitir conexi√≥n.
- **Archivo:** setup-dnsmasq-whitelist.sh l√≠neas 170-173

---

### 3. Falta de ipset para Validaci√≥n de IPs ‚Üí SOLUCIONADO ‚úÖ

**Problema:**
- v2.0 elimin√≥ ipset completamente
- Confiaba solo en filtrado DNS
- F√°cil bypass con IPs cacheadas

**Soluci√≥n:**
- Reintroducido ipset `url_whitelist`
- dnsmasq a√±ade IPs autom√°ticamente: `ipset=/domain/url_whitelist`
- Pre-poblaci√≥n de IPs de dominios base al inicio
- **Archivo:** setup-dnsmasq-whitelist.sh l√≠neas 386-390, 422-451

---

### 4. Rollback Pod√≠a Dejar Sistema sin Internet ‚Üí SOLUCIONADO ‚úÖ

**Problemas:**
- `set -e` causaba salidas abruptas en errores
- Orden de operaciones incorrecto (dnsmasq antes de DNS)
- Sin validaci√≥n de servicios restaurados
- Sin plan de emergencia

**Soluci√≥n:**
- Eliminado `set -e`, a√±adido manejo expl√≠cito de errores
- Orden correcto: systemd-resolved ‚Üí dnsmasq ‚Üí resolv.conf ‚Üí validaci√≥n
- Validaci√≥n de DNS y conectividad
- DNS de emergencia (8.8.8.8) si falla restauraci√≥n
- **Archivo:** rollback-dnsmasq-whitelist.sh (completo)

---

### 5. Liberaci√≥n de Puerto 53 Mejorada ‚Üí SOLUCIONADO ‚úÖ

**Mejoras:**
- Detiene `systemd-resolved.socket` adem√°s del servicio
- Timeout extendido de 10s a 30s
- Mejor diagn√≥stico de errores (muestra procesos usando puerto 53)
- **Archivo:** setup-dnsmasq-whitelist.sh l√≠neas 72-98

---

## üìê Nueva Arquitectura v2.0 Corregida

### Defensa en Tres Capas

**Capa 1: DNS Sinkhole (dnsmasq)**
- Dominios whitelisted: `server=/domain/gateway` + `ipset=/domain/url_whitelist`
- Dominios NO whitelisted: `address=/#/127.0.0.1` (bloqueados)
- dnsmasq a√±ade IPs a ipset autom√°ticamente en tiempo real

**Capa 2: Validaci√≥n de IPs (ipset)**
- ipset `url_whitelist` mantiene lista de IPs permitidas
- Pre-poblado con dominios base al inicio
- Actualizado autom√°ticamente por dnsmasq al resolver dominios

**Capa 3: Firewall (iptables)**
- Bloquea DNS a servidores no-localhost
- Bloquea puertos VPN (OpenVPN, WireGuard, PPTP)
- Bloquea puertos Tor
- **HTTP/HTTPS solo a IPs en ipset** ‚Üê FIX CR√çTICO
- Bloquea acceso directo por IP (excepto redes privadas)

### Detector de Portal Cautivo

Mantiene funcionalidad para WEDU:
- Modo NO autenticado: firewall desactivado (permite login WEDU)
- Modo autenticado: firewall activado (whitelist activa)
- Verifica estado cada 30 segundos

---

## üõ°Ô∏è Prevenci√≥n de Bypass

| M√©todo de Bypass | C√≥mo se Previene |
|------------------|------------------|
| DNS alternativo | iptables bloquea DNS excepto localhost |
| IPs cacheadas | ipset valida IPs en firewall |
| Acceso directo por IP | iptables requiere ipset match para HTTP/HTTPS |
| VPN | iptables bloquea puertos VPN comunes |
| Proxy | Combinaci√≥n DNS + IP validation |
| /etc/hosts | Combinaci√≥n DNS + IP validation |

---

## üì¶ Archivos Modificados

1. **setup-dnsmasq-whitelist.sh** - Script de instalaci√≥n
   - DNS sinkhole funcional (address=/#/)
   - ipset reintroducido y configurado
   - Firewall con validaci√≥n ipset
   - Mejor liberaci√≥n puerto 53
   - Instalaci√≥n de dependencias (a√±adido ipset, dnsutils)

2. **rollback-dnsmasq-whitelist.sh** - Script de rollback
   - Manejo seguro de errores
   - Orden de operaciones correcto
   - Validaci√≥n de DNS y conectividad
   - DNS de emergencia

3. **CLAUDE.md** - Documentaci√≥n
   - Nueva secci√≥n "Architecture v2.0 Corrections"
   - Documentaci√≥n completa de bugs y fixes
   - Explicaci√≥n de nueva arquitectura
   - Gu√≠a de prevenci√≥n de bypass

---

## ‚úÖ Testing Recomendado

Antes de desplegar en otras m√°quinas:

1. **Test DNS Sinkhole:**
   ```bash
   nslookup facebook.com 127.0.0.1  # Debe retornar 127.0.0.1
   nslookup google.es 127.0.0.1    # Debe retornar IP real
   ```

2. **Test ipset:**
   ```bash
   sudo ipset list url_whitelist    # Debe mostrar IPs
   ```

3. **Test Firewall:**
   ```bash
   curl -v https://google.es        # Debe funcionar
   curl -v https://facebook.com     # Debe fallar
   curl -v http://142.250.XXX.XXX   # Debe fallar (IP directa bloqueada)
   ```

4. **Test Rollback:**
   ```bash
   sudo ./rollback-dnsmasq-whitelist.sh
   # Debe restaurar internet completamente
   ```

---

## üöÄ Pr√≥ximos Pasos

1. **Probar rollback en m√°quina afectada** para restaurar internet
2. **Desinstalar versi√≥n v2.0 rota** en todas las m√°quinas
3. **Instalar versi√≥n v2.0 corregida**
4. **Validar funcionamiento** en cada m√°quina
5. **Actualizar repositorio** con commit descriptivo

---

## üìù Notas de Despliegue

- El rollback corregido es seguro de ejecutar
- Si falla, aplicar√° DNS de emergencia (8.8.8.8)
- La nueva instalaci√≥n requiere las mismas dependencias
- Compatible con sistemas existentes (sobrescribe configuraci√≥n)
- Mantiene compatibilidad con portal cautivo WEDU

---

**Autor:** Claude Code
**Revisi√≥n:** v2.0 CORREGIDA - 2025-10-25
