#!/bin/sh
# Pre-commit hook for Whitelist DNS System
# Run linting checks before allowing commit

echo "üîç Running pre-commit checks..."

# Track if any check fails
FAILED=0

# Check for ShellCheck (shell script linting)
if command -v shellcheck >/dev/null 2>&1; then
    echo "üìã Checking shell scripts with ShellCheck..."
    
    # Find shell scripts (excluding node_modules)
    SHELL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' | grep -v node_modules)
    
    if [ -n "$SHELL_FILES" ]; then
        for file in $SHELL_FILES; do
            if ! shellcheck -S warning "$file"; then
                echo "‚ùå ShellCheck failed for: $file"
                FAILED=1
            fi
        done
    fi
else
    echo "‚ö†Ô∏è  ShellCheck not installed, skipping shell lint"
fi

# Check Node.js projects with ESLint
check_npm_lint() {
    local dir=$1
    if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
        # Check if any files in this dir are staged
        STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep "^$dir/")
        if [ -n "$STAGED" ]; then
            echo "üìã Linting $dir..."
            if [ -f "$dir/node_modules/.bin/eslint" ]; then
                (cd "$dir" && npm run lint 2>/dev/null) || {
                    echo "‚ùå ESLint failed for: $dir"
                    FAILED=1
                }
            fi
        fi
    fi
}

check_npm_lint "whitelist-request-api"
check_npm_lint "whitelist-web"
check_npm_lint "oauth-worker"

# Check for sensitive files
echo "üîê Checking for sensitive files..."
SENSITIVE=$(git diff --cached --name-only | grep -iE '\.(pem|key|env|p12|pfx)$|id_rsa|id_dsa' | grep -v '\.example')
if [ -n "$SENSITIVE" ]; then
    echo "‚ùå Potentially sensitive files staged for commit:"
    echo "$SENSITIVE"
    FAILED=1
fi

# Check for large files (>1MB)
echo "üì¶ Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read f; do
    if [ -f "$f" ]; then
        SIZE=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null)
        if [ "$SIZE" -gt 1048576 ]; then
            echo "$f ($(($SIZE / 1024))KB)"
        fi
    fi
done)
if [ -n "$LARGE_FILES" ]; then
    echo "‚ö†Ô∏è  Large files detected (>1MB):"
    echo "$LARGE_FILES"
fi

# Final result
if [ $FAILED -eq 1 ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed. Fix issues and try again."
    echo "   Use 'git commit --no-verify' to skip (not recommended)"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed"
exit 0
