name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  # ============================================
  # Job 1: Lint
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build workspaces
        uses: ./.github/actions/build-workspaces

      - name: Verify Strict Compliance (Lint & Type Check)
        run: npm run verify

      - name: Verify Database Schema Consistency
        run: npm run verify:schema --workspace=@openpath/api

      - name: Shellcheck
        run: |
          find linux -name '*.sh' -type f | xargs shellcheck --severity=warning
          echo "Shellcheck completed successfully"

      - name: PSScriptAnalyzer (Windows PowerShell)
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path windows -Recurse -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            exit 1
          }
          Write-Host "PSScriptAnalyzer completed successfully"

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/dist/**
            !**/coverage/**
          config: '.markdownlint.json'

  # ============================================
  # Job 2: Security Audit
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: NPM Audit (API)
        run: npm audit --audit-level=moderate --workspace=@openpath/api

  # ============================================
  # Job 3: Test Web Application
  # ============================================
  test-web:
    name: Web Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: web
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 4: Test Bash Scripts
  # ============================================
  test-bash:
    name: Bash Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: bash

  # ============================================
  # Job 5: Test Windows PowerShell Scripts
  # ============================================
  test-windows:
    name: Windows Tests
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -Scope CurrentUser
          Import-Module Pester

      - name: Run Windows Unit Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "windows/tests"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "windows-test-results.xml"
          $config.TestResult.OutputFormat = "NUnitXml"
          Invoke-Pester -Configuration $config

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-test-results
          path: windows-test-results.xml
          retention-days: 7

  # ============================================
  # Job 6: Test Request API
  # ============================================
  test-api:
    name: API Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: api
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 7: Test SPA
  # ============================================
  test-spa:
    name: SPA Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: spa
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 8: Test Shared Package
  # ============================================
  test-shared:
    name: Shared Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: shared
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 9: Test Firefox Extension
  # ============================================
  test-firefox-extension:
    name: Extension Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: extension
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 11: SPA E2E Smoke Tests (fast feedback)
  # Full E2E suite runs in e2e-comprehensive.yml
  # ============================================
  test-spa-e2e:
    name: SPA E2E Smoke
    runs-on: ubuntu-latest
    needs: [test-api]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: openpath
          POSTGRES_PASSWORD: openpath_dev
          POSTGRES_DB: openpath
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build workspaces
        uses: ./.github/actions/build-workspaces
        with:
          build-spa: 'true'

      - name: Run DB migrations
        run: npm run drizzle:push --workspace=@openpath/api
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: openpath
          DB_USER: openpath
          DB_PASSWORD: openpath_dev

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: spa

      - name: Run Smoke E2E tests
        run: npx playwright test --grep @smoke --project=chromium
        working-directory: spa
        env:
          CI: true
          PORT: 3001
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: openpath
          DB_USER: openpath
          DB_PASSWORD: openpath_dev
          JWT_SECRET: test-jwt-secret-for-ci-testing
          ADMIN_TOKEN: test-admin-token-for-ci
          SHARED_SECRET: test-shared-secret-for-ci
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: spa/playwright-report/
          retention-days: 7

  # ============================================
  # Job 12: Build Docker Image (Dashboard)
  # ============================================
  build-docker:
    name: Build Dashboard Docker
    needs: [lint, test-web]
    uses: ./.github/workflows/reusable-docker.yml
    with:
      image-name: dashboard
      dockerfile: ./dashboard/Dockerfile
      push: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  # ============================================
  # Job 13: Build Docker Image (API)
  # ============================================
  build-docker-api:
    name: Build API Docker
    needs: [lint, test-api]
    uses: ./.github/workflows/reusable-docker.yml
    with:
      image-name: api
      dockerfile: ./api/Dockerfile
      push: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  # ============================================
  # Summary Job
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, security, test-web, test-bash, test-windows, test-api, test-spa, test-shared, test-firefox-extension, test-spa-e2e, build-docker, build-docker-api]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] ||              [[ "${{ needs.security.result }}" == "failure" ]] ||              [[ "${{ needs.test-web.result }}" == "failure" ]] ||              [[ "${{ needs.test-bash.result }}" == "failure" ]] ||              [[ "${{ needs.test-windows.result }}" == "failure" ]] ||              [[ "${{ needs.test-api.result }}" == "failure" ]] ||              [[ "${{ needs.test-spa.result }}" == "failure" ]] ||              [[ "${{ needs.test-shared.result }}" == "failure" ]] ||              [[ "${{ needs.test-firefox-extension.result }}" == "failure" ]] ||              [[ "${{ needs.test-spa-e2e.result }}" == "failure" ]] ||              [[ "${{ needs.build-docker.result }}" == "failure" ]] ||              [[ "${{ needs.build-docker-api.result }}" == "failure" ]]; then
            echo "CI Failed"
            exit 1
          fi
          echo "All CI checks passed"
