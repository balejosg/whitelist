name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  # ============================================
  # Job 1: Lint
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build workspaces
        uses: ./.github/actions/build-workspaces

      - name: Verify Strict Compliance (Lint & Type Check)
        run: npm run verify

      - name: Shellcheck
        run: |
          find linux -name '*.sh' -type f | xargs shellcheck --severity=warning || true
          echo "Shellcheck completed"

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/dist/**
            !**/coverage/**
          config: '.markdownlint.json'

  # ============================================
  # Job 2: Test Web Application
  # ============================================
  test-web:
    name: Web Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: web
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 3: Test Bash Scripts
  # ============================================
  test-bash:
    name: Bash Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: bash

  # ============================================
  # Job 4: Test Request API
  # ============================================
  test-api:
    name: API Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: api
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 5: Test SPA (Lint & Type Check)
  # ============================================
  test-spa:
    name: SPA Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: spa

  # ============================================
  # Job 6: Build Docker Image (Dashboard)
  # ============================================
  build-docker:
    name: Build Dashboard Docker
    needs: [lint, test-web]
    uses: ./.github/workflows/reusable-docker.yml
    with:
      image-name: dashboard
      dockerfile: ./dashboard/Dockerfile
      push: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  # ============================================
  # Job 7: Build Docker Image (API)
  # ============================================
  build-docker-api:
    name: Build API Docker
    needs: [lint, test-api]
    uses: ./.github/workflows/reusable-docker.yml
    with:
      image-name: api
      dockerfile: ./api/Dockerfile
      push: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  # ============================================
  # Job 8: Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    needs: [build-docker-api]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip deploy]')
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: production
    secrets: inherit

  # ============================================
  # Summary Job
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test-web, test-bash, test-api, test-spa, build-docker, build-docker-api]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test-web.result }}" == "failure" ]] || \
             [[ "${{ needs.test-bash.result }}" == "failure" ]] || \
             [[ "${{ needs.test-api.result }}" == "failure" ]] || \
             [[ "${{ needs.test-spa.result }}" == "failure" ]] || \
             [[ "${{ needs.build-docker.result }}" == "failure" ]] || \
             [[ "${{ needs.build-docker-api.result }}" == "failure" ]]; then
            echo "CI Failed"
            exit 1
          fi
          echo "All CI checks passed"
