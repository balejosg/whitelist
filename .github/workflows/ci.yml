name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  # ============================================
  # Job 1: Lint
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build workspaces
        uses: ./.github/actions/build-workspaces

      - name: Verify Strict Compliance (Lint & Type Check)
        run: npm run verify

      - name: Shellcheck
        run: |
          find linux -name '*.sh' -type f | xargs shellcheck --severity=warning
          echo "Shellcheck completed successfully"

      - name: PSScriptAnalyzer (Windows PowerShell)
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path windows -Recurse -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            exit 1
          }
          Write-Host "PSScriptAnalyzer completed successfully"

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            **/*.md
            !**/node_modules/**
            !**/dist/**
            !**/coverage/**
          config: '.markdownlint.json'

  # ============================================
  # Job 2: Security Audit
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: NPM Audit (API)
        run: npm audit --audit-level=moderate --workspace=@openpath/api

  # ============================================
  # Job 3: Test Web Application
  # ============================================
  test-web:
    name: Web Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: web
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 3: Test Bash Scripts
  # ============================================
  test-bash:
    name: Bash Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: bash

  # ============================================
  # Job 4: Test Windows PowerShell Scripts
  # ============================================
  test-windows:
    name: Windows Tests
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -Scope CurrentUser
          Import-Module Pester

      - name: Run Windows Unit Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "windows/tests"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = "windows-test-results.xml"
          $config.TestResult.OutputFormat = "NUnitXml"
          Invoke-Pester -Configuration $config

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-test-results
          path: windows-test-results.xml
          retention-days: 7

  # ============================================
  # Job 5: Test Request API
  # ============================================
  test-api:
    name: API Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: api
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ============================================
  # Job 6: Test SPA (Lint & Type Check)
  # ============================================
  test-spa:
    name: SPA Tests
    uses: ./.github/workflows/reusable-test.yml
    with:
      test-type: spa

  # ============================================
  # Job 7: Build Docker Image (Dashboard)
  # ============================================
  build-docker:
    name: Build Dashboard Docker
    needs: [lint, test-web]
    uses: ./.github/workflows/reusable-docker.yml
    with:
      image-name: dashboard
      dockerfile: ./dashboard/Dockerfile
      push: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  # ============================================
  # Job 8: Build Docker Image (API)
  # ============================================
  build-docker-api:
    name: Build API Docker
    needs: [lint, test-api]
    uses: ./.github/workflows/reusable-docker.yml
    with:
      image-name: api
      dockerfile: ./api/Dockerfile
      push: ${{ github.event_name != 'pull_request' }}
    secrets: inherit

  # ============================================
  # Job 9: Deploy to Production
  # ============================================
  deploy:
    name: Deploy to Production
    needs: [build-docker-api]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip deploy]')
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: production
    secrets: inherit

  # ============================================
  # Summary Job
  # ============================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, security, test-web, test-bash, test-windows, test-api, test-spa, build-docker, build-docker-api]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.security.result }}" == "failure" ]] || \
             [[ "${{ needs.test-web.result }}" == "failure" ]] || \
             [[ "${{ needs.test-bash.result }}" == "failure" ]] || \
             [[ "${{ needs.test-windows.result }}" == "failure" ]] || \
             [[ "${{ needs.test-api.result }}" == "failure" ]] || \
             [[ "${{ needs.test-spa.result }}" == "failure" ]] || \
             [[ "${{ needs.build-docker.result }}" == "failure" ]] || \
             [[ "${{ needs.build-docker-api.result }}" == "failure" ]]; then
            echo "CI Failed"
            exit 1
          fi
          echo "All CI checks passed"
