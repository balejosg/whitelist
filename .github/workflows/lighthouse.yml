name: Lighthouse CI

on:
  push:
    branches: [main, master]
    paths:
      - 'spa/**'
      - '.github/workflows/lighthouse.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'spa/**'
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build workspaces
        uses: ./.github/actions/build-workspaces
        with:
          build-spa: 'true'

      - name: Start API server
        run: |
          npm start --workspace=@openpath/api &
          sleep 5
        env:
          NODE_ENV: test
          ADMIN_TOKEN: lighthouse-test-token
          JWT_SECRET: lighthouse-test-secret
          PORT: 3001

      - name: Start SPA server
        run: |
          npx -y http-server spa -p 3000 -c-1 &
          sleep 5
          curl -f http://localhost:3000/ || echo "SPA server starting..."
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './spa/lighthouserc.cjs'
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: Format Lighthouse Score
        if: always()
        run: |
          echo "## ðŸ”¦ Lighthouse Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | See artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | See artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "| Best Practices | See artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | See artifacts |" >> $GITHUB_STEP_SUMMARY
