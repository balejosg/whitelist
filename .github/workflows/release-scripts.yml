name: Release Installation Scripts

on:
  push:
    branches: [main, master]
    paths:
      - 'install.sh'
      - 'uninstall.sh'
      - 'lib/**'
      - 'scripts/**'
      - 'whitelist-windows/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ============================================
  # Build and Release Installation Scripts
  # ============================================
  release:
    name: Build and Release Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version and prepare variables
        id: vars
        run: |
          echo "ðŸ“¦ Extracting version from install.sh..."
          
          VERSION=$(grep -oP 'VERSION="\K[^"]+' install.sh)
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG="scripts-v${VERSION}-${SHORT_SHA}"
          
          echo "  Version: $VERSION"
          echo "  Short SHA: $SHORT_SHA"
          echo "  Tag: $TAG"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Installation Scripts v${VERSION} (${SHORT_SHA})" >> $GITHUB_OUTPUT
      
      - name: Create and push tag
        continue-on-error: true
        run: |
          echo "ðŸ·ï¸  Creating tag: ${{ steps.vars.outputs.tag }}"
          git tag "${{ steps.vars.outputs.tag }}"
          git push origin "${{ steps.vars.outputs.tag }}" || echo "Tag already exists or push failed, continuing..."
      
      - name: Package Linux scripts
        run: |
          echo "ðŸ§ Packaging Linux installation scripts..."
          
          VERSION="${{ steps.vars.outputs.version }}"
          PACKAGE_NAME="whitelist-linux-v${VERSION}.tar.gz"
          
          # Create tarball with all necessary Linux files
          echo "  â†’ Creating tarball..."
          tar -czf "$PACKAGE_NAME" \
            install.sh \
            uninstall.sh \
            lib/ \
            scripts/
          
          # Verify
          if [ -f "$PACKAGE_NAME" ]; then
            SIZE=$(du -h "$PACKAGE_NAME" | cut -f1)
            echo "  âœ“ Linux package created: ${PACKAGE_NAME} (${SIZE})"
            
            # List contents for verification
            echo "  â†’ Package contents:"
            tar -tzf "$PACKAGE_NAME" | head -20
          else
            echo "  âœ— Error: Linux package not created"
            exit 1
          fi
      
      - name: Package Windows scripts
        run: |
          echo "ðŸªŸ Packaging Windows installation scripts..."
          
          VERSION="${{ steps.vars.outputs.version }}"
          PACKAGE_NAME="whitelist-windows-v${VERSION}.zip"
          
          # Create ZIP with all Windows files
          echo "  â†’ Creating ZIP archive..."
          zip -r -q "$PACKAGE_NAME" whitelist-windows/
          
          # Verify
          if [ -f "$PACKAGE_NAME" ]; then
            SIZE=$(du -h "$PACKAGE_NAME" | cut -f1)
            echo "  âœ“ Windows package created: ${PACKAGE_NAME} (${SIZE})"
            
            # List contents for verification
            echo "  â†’ Package contents:"
            unzip -l "$PACKAGE_NAME" | head -20
          else
            echo "  âœ— Error: Windows package not created"
            exit 1
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.release_name }}
          prerelease: true
          generate_release_notes: true
          files: |
            whitelist-linux-v${{ steps.vars.outputs.version }}.tar.gz
            whitelist-windows-v${{ steps.vars.outputs.version }}.zip
          body: |
            ## ðŸš€ Installation Scripts Release
            
            **Version:** ${{ steps.vars.outputs.version }}  
            **Commit:** ${{ steps.vars.outputs.short_sha }}
            
            ### ðŸ“¦ Assets
            
            - **`whitelist-linux-v${{ steps.vars.outputs.version }}.tar.gz`** - Linux installation scripts
            - **`whitelist-windows-v${{ steps.vars.outputs.version }}.zip`** - Windows installation scripts
            
            ### ðŸ“ Installation
            
            **Linux:**
            ```bash
            # Download and extract
            wget https://github.com/balejosg/whitelist/releases/download/${{ steps.vars.outputs.tag }}/whitelist-linux-v${{ steps.vars.outputs.version }}.tar.gz
            tar -xzf whitelist-linux-v${{ steps.vars.outputs.version }}.tar.gz
            
            # Run installer
            sudo bash install.sh
            ```
            
            **Windows (PowerShell as Administrator):**
            ```powershell
            # Download and extract
            Invoke-WebRequest -Uri "https://github.com/balejosg/whitelist/releases/download/${{ steps.vars.outputs.tag }}/whitelist-windows-v${{ steps.vars.outputs.version }}.zip" -OutFile "whitelist-windows.zip"
            Expand-Archive -Path "whitelist-windows.zip" -DestinationPath "."
            
            # Run installer
            cd whitelist-windows
            .\Install-Whitelist.ps1
            ```
            
            ### ðŸ“‹ What's Included
            
            **Linux Package:**
            - Main installer (`install.sh`)
            - Uninstaller (`uninstall.sh`)
            - Library modules (`lib/`)
            - Runtime scripts (`scripts/`)
            
            **Windows Package:**
            - PowerShell installer (`Install-Whitelist.ps1`)
            - PowerShell uninstaller (`Uninstall-Whitelist.ps1`)
            - Library modules (`lib/*.psm1`)
            - Runtime scripts (`scripts/*.ps1`)
            - Configuration files
            
            ---
            
            âš ï¸ **Note:** This is a pre-release. Please test in a non-production environment first.
      
      - name: Release summary
        if: success()
        run: |
          echo "## âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.vars.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.vars.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ steps.vars.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Released Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- whitelist-linux-v${{ steps.vars.outputs.version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- whitelist-windows-v${{ steps.vars.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.vars.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
