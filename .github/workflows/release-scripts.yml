name: Release Installation Scripts

on:
  push:
    branches: [main, master]
    paths:
      - 'VERSION'
      - 'linux/install.sh'
      - 'linux/uninstall.sh'
      - 'linux/lib/**'
      - 'linux/scripts/**'
      - 'windows/**'
      - '.github/workflows/release-scripts.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ============================================
  # Build and Release Installation Scripts
  # ============================================
  release:
    name: Build and Release Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Extract version and prepare variables
        id: vars
        run: |
          echo "ðŸ“¦ Extracting version from VERSION file..."
          
          VERSION=$(cat VERSION 2>/dev/null || echo "4.1.0")
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG="scripts-v${VERSION}-${SHORT_SHA}"
          
          echo "  Version: $VERSION"
          echo "  Short SHA: $SHORT_SHA"
          echo "  Tag: $TAG"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "release_name=Installation Scripts v${VERSION} (${SHORT_SHA})" >> $GITHUB_OUTPUT
      
      - name: Create and push tag
        continue-on-error: true
        run: |
          echo "ðŸ·ï¸  Creating tag: ${{ steps.vars.outputs.tag }}"
          git tag "${{ steps.vars.outputs.tag }}"
          git push origin "${{ steps.vars.outputs.tag }}" || echo "Tag already exists or push failed, continuing..."
      
      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build Firefox Extension
        uses: ./.github/actions/build-workspaces
        with:
          build-shared: 'false'
          build-api: 'false'
          build-extension: 'true'

      - name: Validate package contents
        run: |
          echo "ðŸ” Validating package structure before creating release..."
          chmod +x tests/e2e/pre-install-validation.sh
          ./tests/e2e/pre-install-validation.sh
      
      - name: Package Linux scripts
        run: |
          echo "ðŸ§ Packaging Linux installation scripts..."
          
          VERSION="${{ steps.vars.outputs.version }}"
          PACKAGE_NAME="openpath-linux-v${VERSION}.tar.gz"
          
          # Create tarball with all necessary Linux files
          echo "  â†’ Creating tarball..."
          tar -czf "$PACKAGE_NAME" \
            linux/install.sh \
            linux/uninstall.sh \
            linux/lib/ \
            linux/scripts/ \
            firefox-extension/
          
          # Verify
          if [ -f "$PACKAGE_NAME" ]; then
            SIZE=$(du -h "$PACKAGE_NAME" | cut -f1)
            echo "  âœ“ Linux package created: ${PACKAGE_NAME} (${SIZE})"
            
            # List contents for verification
            echo "  â†’ Package contents:"
            tar -tzf "$PACKAGE_NAME" | head -20
          else
            echo "  âœ— Error: Linux package not created"
            exit 1
          fi
      
      - name: Package Windows scripts
        run: |
          echo "ðŸªŸ Packaging Windows installation scripts..."
          
          VERSION="${{ steps.vars.outputs.version }}"
          PACKAGE_NAME="windows-v${VERSION}.zip"
          
          # Create ZIP with all Windows files
          echo "  â†’ Creating ZIP archive..."
          zip -r -q "$PACKAGE_NAME" windows/
          
          # Verify
          if [ -f "$PACKAGE_NAME" ]; then
            SIZE=$(du -h "$PACKAGE_NAME" | cut -f1)
            echo "  âœ“ Windows package created: ${PACKAGE_NAME} (${SIZE})"
            
            # List contents for verification
            echo "  â†’ Package contents:"
            unzip -l "$PACKAGE_NAME" | head -20
          else
            echo "  âœ— Error: Windows package not created"
            exit 1
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.release_name }}
          prerelease: true
          generate_release_notes: true
          files: |
            openpath-linux-v${{ steps.vars.outputs.version }}.tar.gz
            windows-v${{ steps.vars.outputs.version }}.zip
          body: |
            ## ðŸš€ Installation Scripts Release
            
            **Version:** ${{ steps.vars.outputs.version }}  
            **Commit:** ${{ steps.vars.outputs.short_sha }}
            
            ### ðŸ“¦ Assets
            
            - **`openpath-linux-v${{ steps.vars.outputs.version }}.tar.gz`** - Linux installation scripts
            - **`windows-v${{ steps.vars.outputs.version }}.zip`** - Windows installation scripts
            
            ### ðŸ“ Installation
            
            **Linux:**
            ```bash
            # Download and extract
            wget https://github.com/balejosg/openpath/releases/download/${{ steps.vars.outputs.tag }}/openpath-linux-v${{ steps.vars.outputs.version }}.tar.gz
            tar -xzf openpath-linux-v${{ steps.vars.outputs.version }}.tar.gz
            
            # Run installer
            cd linux && sudo bash install.sh
            ```
            
            **Windows (PowerShell as Administrator):**
            ```powershell
            # Download and extract
            Invoke-WebRequest -Uri "https://github.com/balejosg/openpath/releases/download/${{ steps.vars.outputs.tag }}/windows-v${{ steps.vars.outputs.version }}.zip" -OutFile "windows.zip"
            Expand-Archive -Path "windows.zip" -DestinationPath "."
            
            # Run installer
            cd windows
            .\Install-OpenPath.ps1
            ```
            
            ### ðŸ“‹ What's Included
            
            **Linux Package:**
            - Main installer (`install.sh`)
            - Uninstaller (`uninstall.sh`)
            - Library modules (`lib/`)
            - Runtime scripts (`scripts/`)
            - Firefox extension (`firefox-extension/`)
            
            **Windows Package:**
            - PowerShell installer (`Install-OpenPath.ps1`)
            - PowerShell uninstaller (`Uninstall-OpenPath.ps1`)
            - Library modules (`lib/*.psm1`)
            - Runtime scripts (`scripts/*.ps1`)
            - Configuration files
            
            ---
            
            âš ï¸ **Note:** This is a pre-release. Please test in a non-production environment first.
      
      - name: Release summary
        if: success()
        run: |
          echo "## âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.vars.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.vars.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ steps.vars.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Released Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- openpath-linux-v${{ steps.vars.outputs.version }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- windows-v${{ steps.vars.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.vars.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
