# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains a **dnsmasq-based URL whitelist system** for Ubuntu/Debian systems. It provides internet access control by allowing only whitelisted domains while blocking all other traffic. The system is designed with a "fail-open" approach: if the whitelist server is unreachable, no restrictions are applied.

## System Architecture

### Current Version: v3.0 (Hybrid Architecture - DNS Sinkhole Only)

The system has evolved through multiple versions. **v3.0 is the current stable version** with a simplified architecture that eliminates ipset complexity.

### Core Components

1. **Installation Script** (`setup-dnsmasq-whitelist.sh`):
   - One-time setup script that installs and configures the entire system
   - Must be run as root/sudo
   - Detects network gateway AND DNS servers automatically (does NOT assume gateway=DNS)
   - Verifies internet connectivity before installation (detects captive portals)
   - Supports offline installation mode (uses only hardcoded BASE_URLS)
   - Installs dependencies (iptables, iptables-persistent, ipset, curl, dnsutils)
   - **Permanently disables systemd-resolved** to prevent port 53 conflicts
   - Creates the main whitelist manager script and systemd services

2. **Whitelist Manager** (`/usr/local/bin/dnsmasq-whitelist.sh`):
   - Auto-generated by the installer
   - Downloads whitelist from GitHub Gist (https://gist.githubusercontent.com/balejosg/9a81340e7e7bfd044cc031f41af6acdc/raw/whitelist.txt - always latest version)
   - Validates dnsmasq functionality before activating firewall
   - Generates dnsmasq configuration from whitelist
   - **Deduplicates domains** (removes redundant subdomains)
   - Configures iptables rules ONLY if dnsmasq is verified working
   - Runs every 5 minutes via systemd timer

3. **dnsmasq DNS Server**:
   - Listens on localhost (127.0.0.1)
   - Resolves ONLY whitelisted domains against upstream DNS
   - Returns NXDOMAIN for non-whitelisted domains (DNS Sinkhole)
   - Uses detected primary DNS server (not necessarily the gateway)
   - Configured via `/etc/dnsmasq.conf` and `/etc/dnsmasq.d/url-whitelist.conf`

4. **Firewall (iptables only - NO ipset)**:
   - Uses OUTPUT chain to filter outgoing traffic
   - Allows: localhost, established connections, DNS to localhost
   - Allows DNS to primary DNS (for dnsmasq upstream queries)
   - Blocks DNS to other servers (anti-bypass)
   - Blocks VPN ports (OpenVPN, WireGuard, PPTP) and Tor ports
   - **Allows HTTP/HTTPS to ANY IP** (trusts DNS Sinkhole for blocking)
   - Allows traffic to private networks
   - Drops all other traffic

5. **Captive Portal Detector** (`/usr/local/bin/captive-portal-detector.sh`):
   - Monitors authentication status using http://detectportal.firefox.com/success.txt
   - **Waits 60 seconds after boot** before activating (prevents boot issues)
   - When NOT authenticated: disables firewall (permissive mode)
   - When authenticated: enables firewall (restrictive mode)
   - Checks every 30 seconds

### Key Design Decisions

- **DNS Sinkhole Only (NO ipset)**: v3.0 eliminates ipset completely. Only DNS-level filtering is used - whitelisted domains resolve, non-whitelisted domains return NXDOMAIN. This solves CDN dynamic IP problems completely.
- **Trust DNS, Block Bypass**: Firewall allows HTTP/HTTPS to any IP (trusts DNS sinkhole), but aggressively blocks DNS bypass methods (VPN, Tor, alternate DNS servers).
- **Primary DNS Detection**: Automatically detects the correct DNS server (does NOT assume gateway=DNS). Critical for networks where router != DNS server.
- **Offline Installation Support**: Detects captive portals before installation. Can install in offline mode using only hardcoded BASE_URLS if GitHub is unreachable.
- **Domain Deduplication**: Automatically removes redundant subdomains (e.g., if "google.com" exists, removes "www.google.com", "api.google.com"). dnsmasq resolves all subdomains automatically.
- **Fail-Open Strategy**: If the GitHub Gist whitelist cannot be downloaded, the system removes all firewall restrictions to avoid blocking legitimate access.
- **Remote Emergency Disable**: The system can be remotely disabled by adding `# DESACTIVADO` as the first non-empty line in the whitelist file. This triggers fail-open mode across all systems simultaneously.
- **Captive Portal Awareness**: Automatically detects when user is behind captive portal (WEDU login) and disables firewall until authenticated.
- **60-Second Boot Delay**: Captive portal detector waits 60 seconds after boot before activating, preventing network issues during startup.
- **System-Wide Application**: Applies to all users on the system.
- **5-Minute Update Cycle**: Whitelist is re-downloaded every 5 minutes via systemd timer.
- **Symlink-Aware Backups**: Rollback script preserves /etc/resolv.conf symlinks (critical for systemd-resolved compatibility).

### Fail-Safe Protections (Critical)

The system includes multiple layers of protection to prevent loss of internet connectivity:

1. **Captive Portal Detection Pre-Installation**:
   - Checks http://detectportal.firefox.com/success.txt before starting
   - Detects if user is behind WEDU login portal (unauthenticated)
   - Offers offline installation mode if GitHub is unreachable
   - Prevents installation failures due to blocked HTTP/HTTPS

2. **Port 53 Liberation**:
   - **Permanently disables** systemd-resolved (not just stops it)
   - Verifies port 53 is free with 30-second timeout
   - Prevents "address already in use" errors during installation
   - If port fails to free, exits safely without breaking DNS

3. **DNS Server Detection**:
   - Reads DNS servers from /run/systemd/resolve/resolv.conf
   - Falls back to /etc/resolv.conf if systemd-resolved not available
   - Uses gateway as last resort (with warning)
   - Prevents "gateway is not DNS" configuration errors

4. **dnsmasq Installation Validation**:
   - Verifies dnsmasq binary is available after installation
   - Tests configuration syntax before applying
   - Validates dnsmasq is running AND listening on port 53
   - Tests actual DNS resolution (not just process status)
   - Returns failure if ANY check fails

5. **Firewall Activation Protection**:
   - Firewall is configured ONLY AFTER dnsmasq passes all validations
   - If dnsmasq fails validation → fail-open mode (no restrictions)
   - Prevents scenario where firewall blocks everything but DNS is broken
   - Uses iptables-persistent to save rules (survives reboots)

6. **Configuration Backups**:
   - Creates backups of `/etc/systemd/resolved.conf`, `/etc/resolv.conf`, `/etc/dnsmasq.conf`
   - **Preserves symlinks**: If /etc/resolv.conf is symlink, saves link target separately
   - Enables rollback script to restore original configuration byte-for-byte

7. **Symlink-Aware /etc/resolv.conf Handling**:
   - Writes to symlink target without destroying symlink
   - Critical for systems using systemd-resolved with stub resolver
   - Prevents "resolv.conf is immutable" errors

8. **Error Handling**:
   - NO global `set -e` (prevents abrupt exits that leave system broken)
   - Explicit error checking with descriptive logging
   - All critical operations verify success before continuing
   - Fail-open on errors (remove restrictions rather than block everything)

## File Locations

- **Installation script**: `setup-dnsmasq-whitelist.sh` (in repository root)
- **Rollback script**: `rollback-dnsmasq-whitelist.sh` (in repository root)
- **Runtime script**: `/usr/local/bin/dnsmasq-whitelist.sh` (generated during install)
- **Captive portal detector**: `/usr/local/bin/captive-portal-detector.sh` (generated during install)
- **Whitelist file**: `/var/lib/url-whitelist/whitelist.txt`
- **dnsmasq config**: `/etc/dnsmasq.d/url-whitelist.conf`
- **Logs**:
  - `/var/log/url-whitelist.log` (whitelist manager)
  - `/var/log/captive-portal-detector.log` (captive portal detector)
- **systemd services**:
  - `/etc/systemd/system/dnsmasq-whitelist.service`
  - `/etc/systemd/system/captive-portal-detector.service`
- **systemd timer**: `/etc/systemd/system/dnsmasq-whitelist.timer`
- **Backups**:
  - `/etc/systemd/resolved.conf.backup-whitelist`
  - `/etc/resolv.conf.backup-whitelist` (content backup)
  - `/etc/resolv.conf.backup-whitelist.symlink` (symlink target, if applicable)
  - `/etc/dnsmasq.conf.backup-whitelist`

## Hardcoded Base URLs

The system includes hardcoded base URLs in the embedded script that are always whitelisted. **In v3.0, domain deduplication is applied**: only base domains are needed, subdomains are automatically resolved by dnsmasq.

Example: `google.com` automatically allows `www.google.com`, `api.google.com`, `mail.google.com`, etc.

**Current BASE_URLS:**
- **Búsqueda y servicios básicos**: google.es, google.com
- **GitHub y desarrollo**: github.com, githubusercontent.com, github.io
- **CDN comunes**: gstatic.com, googleapis.com, googleusercontent.com, ggpht.com, cloudflare.com, cdnjs.cloudflare.com, akamaihd.net, akamaized.net, cloudfront.net, amazonaws.com
- **Educación Madrid**: nce.wedu.comunidad.madrid, max.educa.madrid.org, educa.madrid.org
- **Ubuntu**: ubuntu.com (covers archive, security, packages subdomains)
- **Anthropic**: anthropic.com, claude.ai
- **Conectividad**: detectportal.firefox.com, connectivity-check.ubuntu.com

**Note**: URLs like `www.google.com`, `api.google.com`, `gist.githubusercontent.com` are NOT needed separately - they're automatically covered by the base domain.

## Testing and Debugging Commands

```bash
# View system status
sudo systemctl status dnsmasq-whitelist.timer
sudo systemctl status dnsmasq.service
sudo systemctl status captive-portal-detector.service

# View logs
sudo tail -f /var/log/url-whitelist.log
sudo tail -f /var/log/captive-portal-detector.log
sudo journalctl -u dnsmasq-whitelist.service -f
sudo journalctl -u captive-portal-detector.service -f

# Manual execution (for testing)
sudo /usr/local/bin/dnsmasq-whitelist.sh
sudo /usr/local/bin/captive-portal-detector.sh  # Run once

# View firewall rules
sudo iptables -L OUTPUT -n -v

# View current whitelist
cat /var/lib/url-whitelist/whitelist.txt

# View dnsmasq configuration
cat /etc/dnsmasq.d/url-whitelist.conf

# Test DNS resolution (whitelisted domain)
dig @127.0.0.1 google.com
nslookup google.com 127.0.0.1

# Test DNS resolution (non-whitelisted domain - should return NXDOMAIN)
dig @127.0.0.1 facebook.com
nslookup facebook.com 127.0.0.1

# Check if captive portal is detected
curl -s http://detectportal.firefox.com/success.txt
# Should return "success" if authenticated, redirect/block if not

# Check which DNS server is being used
cat /etc/resolv.conf
# Should show: nameserver 127.0.0.1

# Disable/Enable system
sudo systemctl disable --now dnsmasq-whitelist.timer
sudo systemctl enable --now dnsmasq-whitelist.timer

# Uninstall system (full rollback)
sudo ./rollback-dnsmasq-whitelist.sh

# Force firewall to permissive mode (emergency)
sudo iptables -F OUTPUT
sudo iptables -P OUTPUT ACCEPT

# Check PRIMARY_DNS configured in scripts
grep PRIMARY_DNS /usr/local/bin/dnsmasq-whitelist.sh
grep PRIMARY_DNS /usr/local/bin/captive-portal-detector.sh
```

## Installation

```bash
sudo ./setup-dnsmasq-whitelist.sh
```

The installer will:
1. Detect network gateway and DNS servers (does NOT assume gateway=DNS)
2. Verify internet connectivity (detects captive portals, offers offline mode)
3. **Permanently disable** systemd-resolved and free port 53
4. Install dependencies (iptables, iptables-persistent, ipset, curl, dnsutils, dnsmasq)
5. Create backup of all configuration files (preserving symlinks)
6. Create captive portal detector script and service
7. Create whitelist manager script
8. Configure dnsmasq to use detected primary DNS server
9. Set system DNS to localhost (preserving symlinks)
10. Create systemd services and timer
11. Download whitelist from GitHub (or use offline mode with BASE_URLS only)
12. Validate dnsmasq functionality (DNS resolution test)
13. Configure firewall ONLY if dnsmasq validation passes
14. Start captive portal detector service

## Modification Guidelines

### Adding URLs to Hardcoded Whitelist

Edit the `BASE_URLS` array in the embedded script (setup-dnsmasq-whitelist.sh:108-121):
```bash
BASE_URLS=(
    "google.es"
    "newdomain.com"  # Add new domains here
)
```

### Changing Whitelist URL

Modify the `WHITELIST_URL` variable (setup-dnsmasq-whitelist.sh:99):
```bash
WHITELIST_URL="https://your-new-url.com/whitelist.txt"
```

### Changing Update Frequency

Edit the timer configuration (setup-dnsmasq-whitelist.sh:426-434):
```bash
OnUnitActiveSec=5min  # Change to desired interval
```

### Fail-Open vs Fail-Closed Behavior

Current behavior is fail-open (setup-dnsmasq-whitelist.sh:344-347). To change to fail-closed, modify the `cleanup_firewall()` function to maintain restrictions instead of removing them.

### Remote Emergency Disable

The system supports remote emergency disabling via a keyword in the whitelist file:

**How it works:**
- The `check_emergency_disable()` function (lines 301-315) checks the first non-empty line of the downloaded whitelist
- If the line contains `# DESACTIVADO` (case-insensitive), the system enters fail-open mode
- This is checked after every successful whitelist download, before applying configurations

**Implementation details:**
```bash
# Function detects variations like:
# DESACTIVADO
# desactivado
# Sistema desactivado
# DESACTIVADO temporalmente
```

**Activation flow:**
1. Download whitelist from GitHub Gist (line 320)
2. Check for emergency disable keyword (line 322)
3. If detected, execute `cleanup_firewall()` and exit (lines 323-326)
4. If not detected, proceed with normal configuration (line 329)

**Use cases:**
- Emergency internet access during incidents
- Temporary unrestricted access for special events
- Simultaneous disable across all systems without physical access
- Quick rollback if whitelist causes issues

**To implement:**
Add `# DESACTIVADO` as the first line of the whitelist file in the GitHub Gist. Within 5 minutes (or immediately if manually executed), all systems will remove restrictions.

**To restore:**
Remove the `# DESACTIVADO` line from the Gist. Systems will re-enable restrictions on next update cycle.

## Rollback / Uninstallation

To completely remove the whitelist system and restore original configuration:

```bash
sudo ./rollback-dnsmasq-whitelist.sh
```

The rollback script will:
1. Stop and disable all whitelist services (timer, service, captive portal detector)
2. Remove generated scripts and configuration files
3. **Re-enable systemd-resolved** (if it was enabled before)
4. Restore original /etc/systemd/resolved.conf
5. Restore original /etc/dnsmasq.conf
6. **Restore /etc/resolv.conf (preserving symlinks)**
7. Restart systemd-resolved
8. Validate DNS functionality (test resolution)
9. Remove firewall rules (set to permissive)
10. Report final connectivity status

**Symlink handling**: The rollback script detects if original /etc/resolv.conf was a symlink and restores it correctly (critical for systemd-resolved compatibility).

## Security Considerations

- The system uses iptables OUTPUT chain filtering, which affects all system users
- **v3.0 does NOT use ipset** - filtering is DNS-only
- systemd-resolved is **permanently disabled** to free port 53
- Detected primary DNS server is used as upstream (not necessarily the gateway)
- All DNS traffic goes through localhost dnsmasq instance
- Firewall blocks VPN, Tor, and alternate DNS servers (anti-bypass)
- HTTP/HTTPS allowed to any IP (trusts DNS sinkhole for blocking)

## Architecture Evolution

### v3.0 Changes (2025-10-28) - CURRENT VERSION

v3.0 simplifies the architecture by **eliminating ipset completely** and relying solely on DNS-level filtering. This solves the dynamic IP problem that plagued v2.0 (CDN IPs changing constantly, ipset becoming stale).

**Key Changes in v3.0:**

1. **NO ipset - DNS Sinkhole Only**:
   - **Removed**: All ipset logic (creation, population, validation)
   - **How it works**: dnsmasq resolves whitelisted domains normally, returns NXDOMAIN for non-whitelisted domains
   - **Why**: CDNs use dynamic IPs that change constantly. ipset becomes stale within minutes, causing legitimate sites to break

2. **Firewall Trusts DNS Sinkhole**:
   - **Changed**: `iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT` (no ipset validation)
   - **Rationale**: If DNS returns NXDOMAIN, user cannot get IP to connect to. No need for IP-level validation
   - **Anti-bypass**: Firewall still blocks alternate DNS servers, VPN, Tor to prevent bypass

3. **Primary DNS Detection**:
   - **Added**: Auto-detection of DNS servers from systemd-resolved and /etc/resolv.conf
   - **Why**: Many networks have gateway != DNS server. Assuming gateway=DNS causes resolution failures
   - **Fallback**: Uses gateway only if no DNS servers detected (with warning)

4. **Domain Deduplication**:
   - **Added**: Automatic removal of redundant subdomains from whitelist
   - **Example**: If "google.com" exists, removes "www.google.com", "api.google.com"
   - **Why**: dnsmasq's `server=/google.com/DNS` automatically resolves ALL subdomains
   - **Benefit**: Smaller dnsmasq config, faster processing

5. **Offline Installation Mode**:
   - **Added**: Pre-installation captive portal detection
   - **Behavior**: If GitHub is unreachable (e.g., behind WEDU login), offers offline install
   - **Offline mode**: Uses only BASE_URLS, skips GitHub download
   - **Timer**: Will download full whitelist once user authenticates

6. **systemd-resolved Permanent Disable**:
   - **Changed**: `systemctl disable systemd-resolved` (not just stop)
   - **Why**: systemd-resolved would re-enable on reboot, causing port 53 conflicts

7. **Symlink-Aware /etc/resolv.conf**:
   - **Added**: Detection and preservation of /etc/resolv.conf symlinks
   - **Implementation**: Writes to symlink target without destroying symlink
   - **Rollback**: Restores symlink correctly (not just file content)

8. **Captive Portal Detector Boot Delay**:
   - **Added**: 60-second delay after boot before activating firewall
   - **Why**: Prevents race conditions where firewall activates before network is ready

9. **iptables-persistent Integration**:
   - **Added**: Automatic save of firewall rules with iptables-persistent
   - **Why**: Ensures rules survive reboots without systemd service ordering issues

**Problems Solved by v3.0:**
- ✅ CDN dynamic IPs (google.com, github.com, etc.) no longer break
- ✅ ipset stale IP problem eliminated
- ✅ "Gateway is not DNS" errors eliminated
- ✅ Installation behind captive portals (WEDU) now works
- ✅ /etc/resolv.conf symlink corruption fixed
- ✅ Boot-time firewall activation race conditions fixed

**Trade-offs:**
- ⚠️ Trusts DNS sinkhole completely (but firewall blocks DNS bypass methods)
- ⚠️ Direct IP access to whitelisted IPs works (but user needs to know the IP, and it changes frequently for CDNs)

---

## Architecture v2.0 Corrections (2025-10-25)

**NOTE**: v2.0 is DEPRECATED. Use v3.0 instead.

The v2.0 architecture had critical flaws that allowed bypass of the whitelist. The following corrections were implemented:

### Critical Bugs Fixed in v2.0

1. **DNS Sinkhole Incomplete**
   - **Problem:** Configuration only defined `server=/domain/gateway` for whitelisted domains but didn't block non-whitelisted domains
   - **Impact:** Non-whitelisted domains could potentially resolve via root hints or other methods
   - **Fix:** Added `address=/#/127.0.0.1` to explicitly block all non-whitelisted domains (setup-dnsmasq-whitelist.sh:394-398)

2. **Firewall Allowed HTTP/HTTPS to ANY IP (CRITICAL)**
   - **Problem:** Firewall rules permitted HTTP/HTTPS to any destination without validation
   ```bash
   # BEFORE (INSECURE):
   iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
   iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT
   ```
   - **Impact:** Users could access any website if they had cached IPs or used direct IP access
   - **Fix:** Added ipset validation to firewall rules (setup-dnsmasq-whitelist.sh:170-173)
   ```bash
   # AFTER (SECURE):
   iptables -A OUTPUT -p tcp --dport 80 -m set --match-set url_whitelist dst -j ACCEPT
   iptables -A OUTPUT -p tcp --dport 443 -m set --match-set url_whitelist dst -j ACCEPT
   ```

3. **Missing ipset Implementation**
   - **Problem:** v2.0 removed ipset completely, relying only on DNS filtering
   - **Impact:** No IP-level validation, easy to bypass with cached IPs
   - **Fix:** Reintroduced ipset with automatic population via dnsmasq (setup-dnsmasq-whitelist.sh:386-390, 422-451)

4. **Rollback Script Could Brick Network**
   - **Problem:** `set -e` caused abrupt exits, wrong order of operations could leave system without DNS
   - **Impact:** Running rollback could leave machines without internet
   - **Fix:** Removed `set -e`, improved operation order, added validation and emergency DNS fallback (rollback-dnsmasq-whitelist.sh)

### How v2.0 Now Works (Corrected Architecture)

**Three-Layer Defense:**

1. **Layer 1: DNS Sinkhole (dnsmasq)**
   - Whitelisted domains: `server=/domain/gateway` + `ipset=/domain/url_whitelist`
   - Non-whitelisted domains: `address=/#/127.0.0.1` (blocked)
   - dnsmasq automatically adds resolved IPs to ipset in real-time

2. **Layer 2: IP Validation (ipset)**
   - ipset `url_whitelist` maintains list of allowed IPs
   - Pre-populated with base domains on startup
   - Automatically updated by dnsmasq as domains are resolved

3. **Layer 3: Firewall (iptables)**
   - Blocks DNS queries to non-localhost servers
   - Blocks VPN ports (OpenVPN, WireGuard, PPTP)
   - Blocks Tor ports
   - **Allows HTTP/HTTPS ONLY to IPs in ipset** (critical fix)
   - Blocks direct IP access (except private networks)

**Captive Portal Detection:**
- `captive-portal-detector.sh` monitors network authentication status
- When NOT authenticated (e.g., WEDU login required): firewall disabled (permissive mode)
- When authenticated: firewall enabled (restrictive mode with whitelist)
- Checks every 30 seconds using http://detectportal.firefox.com/success.txt

**Bypass Prevention:**
- DNS bypass: Blocked via iptables (only localhost DNS allowed)
- Cached IP bypass: Blocked via ipset validation in firewall
- Direct IP bypass: Blocked via iptables (HTTP/HTTPS requires ipset match)
- VPN bypass: Blocked via iptables (common VPN ports dropped)
- Proxy bypass: Prevented by DNS+IP validation
- /etc/hosts bypass: Prevented by DNS+IP validation

### Rollback Script Improvements

**Before (Dangerous):**
- `set -e` caused abrupt exits on errors
- Could leave system without DNS if operations failed mid-execution
- No validation of restored configuration

**After (Safe):**
- Explicit error handling (no `set -e`)
- Correct operation order: systemd-resolved → dnsmasq → resolv.conf → validation
- Validates DNS functionality after restoration
- Emergency DNS fallback to 8.8.8.8 if restoration fails
- Reports connectivity status to user

## Known Issues Fixed (2025-01-24)

### Critical Bugs Resolved

1. **Hardcoded Gist URL with Commit Hash**
   - **Problem:** URL contained commit hash, breaking remote updates
   - **Impact:** Systems continued using old whitelist version after edits
   - **Fix:** Removed hash to always fetch latest version

2. **Complete Internet Loss During Installation**
   - **Problem:** Port 53 not freed before dnsmasq installation + firewall activated before validating DNS
   - **Impact:** System left without internet connectivity
   - **Fix:**
     - Stop systemd-resolved BEFORE apt install
     - Validate dnsmasq functionality BEFORE activating firewall
     - Fail-safe: never activate firewall if DNS doesn't work

3. **iptables Rule Count Bug**
   - **Problem:** `grep -c` with `|| echo "0"` returned `"0\n0"`, causing bash integer comparison error
   - **Impact:** Script error during execution
   - **Fix:** Use `wc -l` with explicit integer validation

4. **No Configuration Backups**
   - **Problem:** Rollback script expected backups that were never created
   - **Impact:** Rollback couldn't restore original configuration
   - **Fix:** Create backups of all modified system files before changes

5. **Aggressive Error Handling**
   - **Problem:** `set -e` caused script to exit on any error, leaving system in inconsistent state
   - **Impact:** Partial configuration with broken state
   - **Fix:** Removed `set -e`, added explicit error handling with fail-safe behavior

### Installation Flow Improvements

**Before (Broken):**
1. Install dnsmasq → FAILS (port 53 busy)
2. Configure firewall → Blocks everything
3. Restart dnsmasq → May fail silently
4. **Result:** No internet

**After (Safe):**
1. Stop systemd-resolved
2. Verify port 53 free
3. Install dnsmasq (without auto-start)
4. Generate configuration
5. Restart and VALIDATE dnsmasq
6. ONLY IF validation passes → Configure firewall
7. **Result:** Either working whitelist or fail-open (full access)
