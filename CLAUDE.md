# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains a **dnsmasq-based URL whitelist system** for Ubuntu/Debian systems. It provides internet access control by allowing only whitelisted domains while blocking all other traffic. The system is designed with a "fail-open" approach: if the whitelist server is unreachable, no restrictions are applied.

## System Architecture

### Core Components

1. **Installation Script** (`setup-dnsmasq-whitelist.sh`):
   - One-time setup script that installs and configures the entire system
   - Must be run as root/sudo
   - Detects network gateway automatically
   - Installs dependencies (ipset, iptables, dnsmasq, curl)
   - Creates the main whitelist manager script and systemd services

2. **Whitelist Manager** (`/usr/local/bin/dnsmasq-whitelist.sh`):
   - Auto-generated by the installer (lines 119-437)
   - Downloads whitelist from GitHub Gist (https://gist.githubusercontent.com/balejosg/9a81340e7e7bfd044cc031f41af6acdc/raw/whitelist.txt - always latest version)
   - Validates dnsmasq functionality before activating firewall
   - Generates dnsmasq configuration from whitelist
   - Configures iptables rules and ipset ONLY if dnsmasq is verified working
   - Runs every 5 minutes via systemd timer

3. **dnsmasq DNS Server**:
   - Listens on localhost (127.0.0.1)
   - Resolves DNS queries and automatically adds resolved IPs to ipset
   - Uses router as upstream DNS server
   - Configured via `/etc/dnsmasq.conf` and `/etc/dnsmasq.d/url-whitelist.conf`

4. **Firewall (iptables + ipset)**:
   - Uses OUTPUT chain to filter outgoing traffic
   - ipset name: `url_whitelist`
   - Allows: localhost, established connections, DNS queries, and whitelisted IPs
   - Drops all other traffic

### Key Design Decisions

- **Dynamic IP Resolution**: Uses dnsmasq + ipset to solve the dynamic IP problem. When dnsmasq resolves a whitelisted domain, it automatically adds the IP to ipset in real-time.
- **Fail-Open Strategy**: If the GitHub Gist whitelist cannot be downloaded, the system removes all firewall restrictions to avoid blocking legitimate access.
- **Remote Emergency Disable**: The system can be remotely disabled by adding `# DESACTIVADO` as the first non-empty line in the whitelist file. This triggers fail-open mode across all systems simultaneously.
- **System-Wide Application**: Applies to all users on the system.
- **5-Minute Update Cycle**: Whitelist is re-downloaded every 5 minutes via systemd timer.

### Fail-Safe Protections (Critical)

The system includes multiple layers of protection to prevent loss of internet connectivity:

1. **Port 53 Liberation** (setup-dnsmasq-whitelist.sh:55-92):
   - Stops systemd-resolved BEFORE installing dnsmasq
   - Verifies port 53 is free with 10-second timeout
   - Prevents "address already in use" errors during installation

2. **dnsmasq Validation** (setup-dnsmasq-whitelist.sh:323-358):
   - After restart, validates dnsmasq is actually running
   - Checks that it's listening on port 53
   - Tests DNS resolution functionality
   - Returns failure if ANY check fails

3. **Firewall Activation Protection** (setup-dnsmasq-whitelist.sh:403-428):
   - Firewall is configured ONLY AFTER dnsmasq passes all validations
   - If dnsmasq fails validation â†’ fail-open mode (no restrictions)
   - Prevents scenario where firewall blocks everything but DNS is broken

4. **Configuration Backups** (setup-dnsmasq-whitelist.sh:60-63, 393-397, 426-430):
   - Creates backups of `/etc/systemd/resolved.conf`, `/etc/resolv.conf`, `/etc/dnsmasq.conf`
   - Enables rollback script to restore original configuration

5. **Error Handling**:
   - Removed global `set -e` to avoid abrupt exits
   - Explicit error checking with descriptive logging
   - All critical operations verify success before continuing

## File Locations

- **Installation script**: `setup-dnsmasq-whitelist.sh` (in repository root)
- **Runtime script**: `/usr/local/bin/dnsmasq-whitelist.sh` (generated during install)
- **Whitelist file**: `/var/lib/url-whitelist/whitelist.txt`
- **dnsmasq config**: `/etc/dnsmasq.d/url-whitelist.conf`
- **Logs**: `/var/log/url-whitelist.log`
- **systemd service**: `/etc/systemd/system/dnsmasq-whitelist.service`
- **systemd timer**: `/etc/systemd/system/dnsmasq-whitelist.timer`

## Hardcoded Base URLs

The system includes hardcoded base URLs (lines 140-153 in embedded script) that are always whitelisted:
- google.es (for basic web access)
- github.com, gist.githubusercontent.com (for whitelist download)
- nce.wedu.comunidad.madrid, max.educa.madrid.org (education sites)
- archive.ubuntu.com, security.ubuntu.com (system updates)
- anthropic.com, claude.ai (Claude AI access)
- deb.nodesource.com (Node.js packages)

## Testing and Debugging Commands

```bash
# View system status
sudo systemctl status dnsmasq-whitelist.timer
sudo systemctl status dnsmasq.service

# View logs
sudo tail -f /var/log/url-whitelist.log
sudo journalctl -u dnsmasq-whitelist.service -f

# Manual execution (for testing)
sudo /usr/local/bin/dnsmasq-whitelist.sh

# View firewall rules
sudo iptables -L OUTPUT -n -v

# View whitelisted IPs
sudo ipset list url_whitelist

# View current whitelist
cat /var/lib/url-whitelist/whitelist.txt

# View dnsmasq configuration
cat /etc/dnsmasq.d/url-whitelist.conf

# Test DNS resolution
nslookup example.com 127.0.0.1
dig @127.0.0.1 example.com

# Disable/Enable system
sudo systemctl disable --now dnsmasq-whitelist.timer
sudo systemctl enable --now dnsmasq-whitelist.timer
```

## Installation

```bash
sudo ./setup-dnsmasq-whitelist.sh
```

The installer will:
1. Install dependencies
2. Configure dnsmasq with CAP_NET_ADMIN capability
3. Configure systemd-resolved to free port 53
4. Create the whitelist manager script
5. Configure dnsmasq to use router as upstream DNS
6. Set system DNS to localhost
7. Create systemd service and timer
8. Perform initial whitelist download and system configuration

## Modification Guidelines

### Adding URLs to Hardcoded Whitelist

Edit the `BASE_URLS` array in the embedded script (setup-dnsmasq-whitelist.sh:108-121):
```bash
BASE_URLS=(
    "google.es"
    "newdomain.com"  # Add new domains here
)
```

### Changing Whitelist URL

Modify the `WHITELIST_URL` variable (setup-dnsmasq-whitelist.sh:99):
```bash
WHITELIST_URL="https://your-new-url.com/whitelist.txt"
```

### Changing Update Frequency

Edit the timer configuration (setup-dnsmasq-whitelist.sh:426-434):
```bash
OnUnitActiveSec=5min  # Change to desired interval
```

### Fail-Open vs Fail-Closed Behavior

Current behavior is fail-open (setup-dnsmasq-whitelist.sh:344-347). To change to fail-closed, modify the `cleanup_firewall()` function to maintain restrictions instead of removing them.

### Remote Emergency Disable

The system supports remote emergency disabling via a keyword in the whitelist file:

**How it works:**
- The `check_emergency_disable()` function (lines 301-315) checks the first non-empty line of the downloaded whitelist
- If the line contains `# DESACTIVADO` (case-insensitive), the system enters fail-open mode
- This is checked after every successful whitelist download, before applying configurations

**Implementation details:**
```bash
# Function detects variations like:
# DESACTIVADO
# desactivado
# Sistema desactivado
# DESACTIVADO temporalmente
```

**Activation flow:**
1. Download whitelist from GitHub Gist (line 320)
2. Check for emergency disable keyword (line 322)
3. If detected, execute `cleanup_firewall()` and exit (lines 323-326)
4. If not detected, proceed with normal configuration (line 329)

**Use cases:**
- Emergency internet access during incidents
- Temporary unrestricted access for special events
- Simultaneous disable across all systems without physical access
- Quick rollback if whitelist causes issues

**To implement:**
Add `# DESACTIVADO` as the first line of the whitelist file in the GitHub Gist. Within 5 minutes (or immediately if manually executed), all systems will remove restrictions.

**To restore:**
Remove the `# DESACTIVADO` line from the Gist. Systems will re-enable restrictions on next update cycle.

## Security Considerations

- The system uses iptables OUTPUT chain filtering, which affects all system users
- CAP_NET_ADMIN capability is granted to dnsmasq (line 106) to allow ipset modifications
- systemd-resolved is configured to use the router as upstream DNS
- All DNS traffic goes through localhost dnsmasq instance

## Architecture v2.0 Corrections (2025-10-25)

The v2.0 architecture had critical flaws that allowed bypass of the whitelist. The following corrections were implemented:

### Critical Bugs Fixed in v2.0

1. **DNS Sinkhole Incomplete**
   - **Problem:** Configuration only defined `server=/domain/gateway` for whitelisted domains but didn't block non-whitelisted domains
   - **Impact:** Non-whitelisted domains could potentially resolve via root hints or other methods
   - **Fix:** Added `address=/#/127.0.0.1` to explicitly block all non-whitelisted domains (setup-dnsmasq-whitelist.sh:394-398)

2. **Firewall Allowed HTTP/HTTPS to ANY IP (CRITICAL)**
   - **Problem:** Firewall rules permitted HTTP/HTTPS to any destination without validation
   ```bash
   # BEFORE (INSECURE):
   iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
   iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT
   ```
   - **Impact:** Users could access any website if they had cached IPs or used direct IP access
   - **Fix:** Added ipset validation to firewall rules (setup-dnsmasq-whitelist.sh:170-173)
   ```bash
   # AFTER (SECURE):
   iptables -A OUTPUT -p tcp --dport 80 -m set --match-set url_whitelist dst -j ACCEPT
   iptables -A OUTPUT -p tcp --dport 443 -m set --match-set url_whitelist dst -j ACCEPT
   ```

3. **Missing ipset Implementation**
   - **Problem:** v2.0 removed ipset completely, relying only on DNS filtering
   - **Impact:** No IP-level validation, easy to bypass with cached IPs
   - **Fix:** Reintroduced ipset with automatic population via dnsmasq (setup-dnsmasq-whitelist.sh:386-390, 422-451)

4. **Rollback Script Could Brick Network**
   - **Problem:** `set -e` caused abrupt exits, wrong order of operations could leave system without DNS
   - **Impact:** Running rollback could leave machines without internet
   - **Fix:** Removed `set -e`, improved operation order, added validation and emergency DNS fallback (rollback-dnsmasq-whitelist.sh)

### How v2.0 Now Works (Corrected Architecture)

**Three-Layer Defense:**

1. **Layer 1: DNS Sinkhole (dnsmasq)**
   - Whitelisted domains: `server=/domain/gateway` + `ipset=/domain/url_whitelist`
   - Non-whitelisted domains: `address=/#/127.0.0.1` (blocked)
   - dnsmasq automatically adds resolved IPs to ipset in real-time

2. **Layer 2: IP Validation (ipset)**
   - ipset `url_whitelist` maintains list of allowed IPs
   - Pre-populated with base domains on startup
   - Automatically updated by dnsmasq as domains are resolved

3. **Layer 3: Firewall (iptables)**
   - Blocks DNS queries to non-localhost servers
   - Blocks VPN ports (OpenVPN, WireGuard, PPTP)
   - Blocks Tor ports
   - **Allows HTTP/HTTPS ONLY to IPs in ipset** (critical fix)
   - Blocks direct IP access (except private networks)

**Captive Portal Detection:**
- `captive-portal-detector.sh` monitors network authentication status
- When NOT authenticated (e.g., WEDU login required): firewall disabled (permissive mode)
- When authenticated: firewall enabled (restrictive mode with whitelist)
- Checks every 30 seconds using http://detectportal.firefox.com/success.txt

**Bypass Prevention:**
- DNS bypass: Blocked via iptables (only localhost DNS allowed)
- Cached IP bypass: Blocked via ipset validation in firewall
- Direct IP bypass: Blocked via iptables (HTTP/HTTPS requires ipset match)
- VPN bypass: Blocked via iptables (common VPN ports dropped)
- Proxy bypass: Prevented by DNS+IP validation
- /etc/hosts bypass: Prevented by DNS+IP validation

### Rollback Script Improvements

**Before (Dangerous):**
- `set -e` caused abrupt exits on errors
- Could leave system without DNS if operations failed mid-execution
- No validation of restored configuration

**After (Safe):**
- Explicit error handling (no `set -e`)
- Correct operation order: systemd-resolved â†’ dnsmasq â†’ resolv.conf â†’ validation
- Validates DNS functionality after restoration
- Emergency DNS fallback to 8.8.8.8 if restoration fails
- Reports connectivity status to user

## Known Issues Fixed (2025-01-24)

### Critical Bugs Resolved

1. **Hardcoded Gist URL with Commit Hash**
   - **Problem:** URL contained commit hash, breaking remote updates
   - **Impact:** Systems continued using old whitelist version after edits
   - **Fix:** Removed hash to always fetch latest version

2. **Complete Internet Loss During Installation**
   - **Problem:** Port 53 not freed before dnsmasq installation + firewall activated before validating DNS
   - **Impact:** System left without internet connectivity
   - **Fix:**
     - Stop systemd-resolved BEFORE apt install
     - Validate dnsmasq functionality BEFORE activating firewall
     - Fail-safe: never activate firewall if DNS doesn't work

3. **iptables Rule Count Bug**
   - **Problem:** `grep -c` with `|| echo "0"` returned `"0\n0"`, causing bash integer comparison error
   - **Impact:** Script error during execution
   - **Fix:** Use `wc -l` with explicit integer validation

4. **No Configuration Backups**
   - **Problem:** Rollback script expected backups that were never created
   - **Impact:** Rollback couldn't restore original configuration
   - **Fix:** Create backups of all modified system files before changes

5. **Aggressive Error Handling**
   - **Problem:** `set -e` caused script to exit on any error, leaving system in inconsistent state
   - **Impact:** Partial configuration with broken state
   - **Fix:** Removed `set -e`, added explicit error handling with fail-safe behavior

### Installation Flow Improvements

**Before (Broken):**
1. Install dnsmasq â†’ FAILS (port 53 busy)
2. Configure firewall â†’ Blocks everything
3. Restart dnsmasq â†’ May fail silently
4. **Result:** No internet

**After (Safe):**
1. Stop systemd-resolved
2. Verify port 53 free
3. Install dnsmasq (without auto-start)
4. Generate configuration
5. Restart and VALIDATE dnsmasq
6. ONLY IF validation passes â†’ Configure firewall
7. **Result:** Either working whitelist or fail-open (full access)
