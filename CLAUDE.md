# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains a **dnsmasq-based URL whitelist system** for Ubuntu/Debian systems. It provides internet access control by allowing only whitelisted domains while blocking all other traffic. The system is designed with a "fail-open" approach: if the whitelist server is unreachable, no restrictions are applied.

## System Architecture

### Current Version: v3.3 (2025-10-30)

v3.3 introduces **idempotent installation**, **interactive URL configuration**, **offline installation mode**, and **enhanced DNS detection** with support for dynamic network environments.

### Core Components

1. **Installation Script** (`setup-dnsmasq-whitelist.sh`):
   - One-time setup script that installs and configures the entire system
   - Must be run as root/sudo
   - **Idempotent**: Detects existing installation and offers Reinstall/Repair/Cancel options
   - **Interactive URL configuration**: Prompts for whitelist URL with LasEncinasIT as default
   - **Command-line arguments**: Supports `--whitelist-url "https://..."` for automated deployments
   - **Captive portal detection**: Checks connectivity before installation, offers offline mode
   - **5-Method DNS detection**: NetworkManager → backup → systemd-resolved → resolv.conf → gateway → Google DNS
   - **Offline mode support**: Can install with only hardcoded BASE_URLS if GitHub is unreachable
   - Permanently disables systemd-resolved to free port 53
   - Installs dependencies (iptables, iptables-persistent, dnsutils, curl, dnsmasq)
   - Creates the main whitelist manager script and systemd services

2. **Whitelist Manager** (`/usr/local/bin/dnsmasq-whitelist.sh`):
   - Auto-generated by the installer (lines 870-1412)
   - **URL configurable**: Uses URL specified during installation (default: LasEncinasIT)
   - **Dynamic DNS detection**: Re-detects DNS on every execution (adapts to network changes)
   - **DNS change caching**: Only regenerates config when DNS actually changes
   - Downloads whitelist from configured URL
   - **Domain deduplication**: Removes redundant subdomains (e.g., google.com covers www.google.com)
   - Validates dnsmasq functionality before activating firewall
   - Generates dnsmasq configuration (DNS Sinkhole architecture)
   - **Hybrid architecture**: DNS-only filtering + anti-bypass firewall
   - Runs every 5 minutes via systemd timer

3. **dnsmasq DNS Server**:
   - Listens on localhost (127.0.0.1)
   - **DNS Sinkhole**: Resolves ONLY whitelisted domains, returns NXDOMAIN for others
   - Uses detected primary DNS server as upstream (not necessarily gateway)
   - **Optional ipset support**: Auto-detects if dnsmasq supports ipset (old versions don't)
   - Configured via `/etc/dnsmasq.conf` and `/etc/dnsmasq.d/url-whitelist.conf`

4. **Firewall (iptables with optional ipset)**:
   - Uses OUTPUT chain to filter outgoing traffic
   - **Allows HTTP/HTTPS to ANY IP** (trusts DNS Sinkhole for blocking)
   - Blocks DNS queries to non-localhost servers (anti-bypass)
   - Blocks DNS queries to servers other than localhost and primary DNS
   - Blocks VPN ports (OpenVPN, WireGuard, PPTP) and Tor ports
   - Allows traffic to private networks and localhost
   - Drops all other traffic

5. **Captive Portal Detector** (`/usr/local/bin/captive-portal-detector.sh`):
   - Auto-generated by the installer (lines 691-862)
   - Monitors authentication status using http://detectportal.firefox.com/success.txt
   - **Dynamic DNS detection**: Re-detects primary DNS before configuring firewall
   - **60-second boot delay**: Waits for network to stabilize after boot
   - When NOT authenticated: disables firewall (permissive mode for login)
   - When authenticated: enables firewall (restrictive mode with whitelist)
   - Checks every 30 seconds

6. **Debug Collection Script** (`collect_debug_info.sh`):
   - New utility script for troubleshooting
   - Collects system info, service status, network config, firewall rules, logs
   - Outputs to `debug_info.txt`
   - Usage: `sudo ./collect_debug_info.sh`

### Key Design Decisions

- **DNS Sinkhole Only (No ipset requirement)**: v3.0+ prioritizes DNS-level filtering. Only whitelisted domains resolve; non-whitelisted domains return NXDOMAIN. ipset is optional (auto-detected).
- **Trust DNS, Block Bypass**: Firewall allows HTTP/HTTPS to any IP (trusts DNS sinkhole), but blocks DNS bypass methods (VPN, Tor, alternate DNS servers).
- **Dynamic DNS Detection**: DNS server is detected on EVERY execution using multiple methods, adapting to network changes (mobile devices, DHCP changes).
- **DNS Change Caching**: Caches last detected DNS to avoid unnecessary config regeneration. Only updates when DNS actually changes.
- **Offline Installation Support**: Detects captive portals before installation. Can install in offline mode using only hardcoded BASE_URLS.
- **Domain Deduplication**: Automatically removes redundant subdomains (e.g., if "google.com" exists, removes "www.google.com"). dnsmasq resolves all subdomains automatically.
- **Interactive URL Configuration**: Prompts user for whitelist URL during installation, with LasEncinasIT as institutional default.
- **Idempotent Installation**: Detects existing installations and offers repair/reinstall options instead of failing.
- **Fail-Open Strategy**: If whitelist download fails, system removes all firewall restrictions to avoid blocking legitimate access.
- **Remote Emergency Disable**: System can be remotely disabled by adding `# DESACTIVADO` as first non-empty line in whitelist file.
- **Captive Portal Awareness**: Automatically detects when user is behind captive portal (WEDU login) and disables firewall until authenticated.
- **Symlink-Aware Backups**: Preserves /etc/resolv.conf symlinks during backup/restore (critical for systemd-resolved compatibility).
- **System-Wide Application**: Applies to all users on the system.
- **5-Minute Update Cycle**: Whitelist is re-downloaded every 5 minutes via systemd timer.

### Fail-Safe Protections (Critical)

The system includes multiple layers of protection to prevent loss of internet connectivity:

1. **Captive Portal Detection Pre-Installation** (setup-dnsmasq-whitelist.sh:283-334):
   - Checks http://detectportal.firefox.com/success.txt before starting
   - Detects if user is behind WEDU login portal (unauthenticated)
   - Offers offline installation mode if GitHub is unreachable
   - Prevents installation failures due to blocked HTTP/HTTPS

2. **Port 53 Liberation** (setup-dnsmasq-whitelist.sh:538-640):
   - Detects and stops existing dnsmasq (from previous installations)
   - **Permanently disables** systemd-resolved (not just stops it)
   - Verifies port 53 is free with 30-second timeout
   - Intelligent process identification (dnsmasq vs systemd-resolved)
   - Automatic recovery attempts if port is still busy
   - Prevents "address already in use" errors during installation

3. **5-Method DNS Detection** (setup-dnsmasq-whitelist.sh:179-276):
   - Priority 1: DNS from previous installation (most reliable)
   - Priority 2: NetworkManager detection (best for DHCP networks)
   - Priority 3: systemd-resolved (if active and not corrupted)
   - Priority 4: /etc/resolv.conf parsing
   - Priority 5: Test gateway as DNS
   - Fallback: Google DNS (8.8.8.8)
   - Validates each DNS server with actual query test
   - **Critical**: Does NOT assume gateway = DNS (common mistake)

4. **dnsmasq Installation Validation** (setup-dnsmasq-whitelist.sh:642-666):
   - Verifies dnsmasq binary is available after installation
   - Uses RUNLEVEL=1 to prevent auto-start during installation
   - Falls back to systemd-resolved if installation fails

5. **dnsmasq Functionality Validation** (setup-dnsmasq-whitelist.sh:380-428):
   - **3-second initialization delay** before testing
   - Tests 1: systemctl is-active check
   - Test 2: Port 53 binding verification (ss -tulpn)
   - Test 3: Actual DNS resolution test (nslookup)
   - **10 attempts with 2-second delays** for each test
   - Returns failure if ANY test fails after all attempts

6. **Firewall Activation Protection** (setup-dnsmasq-whitelist.sh:1618-1702):
   - Whitelist script runs FIRST to configure dnsmasq
   - Validates dnsmasq functionality BEFORE changing system DNS
   - Re-validates after configuration is applied
   - System DNS changed to localhost ONLY after all validations pass
   - If any validation fails → cleanup_failed_installation() triggered
   - Prevents scenario where firewall blocks everything but DNS is broken

7. **Failed Installation Cleanup** (setup-dnsmasq-whitelist.sh:430-510):
   - Stops and disables dnsmasq
   - Re-enables and restarts systemd-resolved
   - Restores original /etc/resolv.conf
   - Verifies internet connectivity after restoration
   - Provides emergency DNS fallback (8.8.8.8) if no backup exists
   - Cleans up partially installed services

8. **Configuration Backups with Symlink Preservation** (setup-dnsmasq-whitelist.sh:562-565, 1505-1516):
   - Creates backups of `/etc/systemd/resolved.conf`, `/etc/resolv.conf`, `/etc/dnsmasq.conf`
   - **Detects symlinks**: If /etc/resolv.conf is symlink, saves target separately
   - Enables rollback script to restore original configuration byte-for-byte
   - Critical for systemd-resolved compatibility

9. **Symlink-Aware /etc/resolv.conf Handling** (setup-dnsmasq-whitelist.sh:512-526):
   - `write_resolv_conf()` function preserves symlinks
   - Writes to symlink target without destroying symlink
   - Critical for systems using systemd-resolved with stub resolver

10. **Error Handling**:
    - NO global `set -e` (prevents abrupt exits that leave system broken)
    - Explicit error checking with descriptive logging
    - All critical operations verify success before continuing
    - Fail-open on errors (remove restrictions rather than block everything)

## File Locations

- **Installation script**: `setup-dnsmasq-whitelist.sh` (in repository root)
- **Rollback script**: `rollback-dnsmasq-whitelist.sh` (in repository root)
- **Debug collection script**: `collect_debug_info.sh` (in repository root)
- **Runtime script**: `/usr/local/bin/dnsmasq-whitelist.sh` (generated during install)
- **Captive portal detector**: `/usr/local/bin/captive-portal-detector.sh` (generated during install)
- **Whitelist file**: `/var/lib/url-whitelist/whitelist.txt`
- **dnsmasq config**: `/etc/dnsmasq.d/url-whitelist.conf`
- **Logs**:
  - `/var/log/url-whitelist.log` (whitelist manager)
  - `/var/log/captive-portal-detector.log` (captive portal detector)
- **systemd services**:
  - `/etc/systemd/system/dnsmasq-whitelist.service`
  - `/etc/systemd/system/captive-portal-detector.service`
- **systemd timer**: `/etc/systemd/system/dnsmasq-whitelist.timer`
- **DNS Configuration**:
  - `/var/lib/url-whitelist/original-dns.conf` (DNS detected during installation, used as fallback)
  - `/var/lib/url-whitelist/current-dns.cache` (last detected DNS, used to detect changes)
- **Backups**:
  - `/etc/systemd/resolved.conf.backup-whitelist`
  - `/etc/resolv.conf.backup-whitelist` (content backup)
  - `/etc/resolv.conf.backup-whitelist.symlink` (symlink target, if applicable)
  - `/etc/dnsmasq.conf.backup-whitelist`

## Hardcoded Base URLs

The system includes hardcoded base URLs in the embedded script (lines 895-932) that are always whitelisted. **Domain deduplication is applied**: only base domains are needed, subdomains are automatically resolved by dnsmasq.

**Example**: `google.com` automatically allows `www.google.com`, `api.google.com`, `mail.google.com`, etc.

**Current BASE_URLS:**
- **Búsqueda y servicios básicos**: google.es, google.com
- **GitHub y desarrollo**: github.com, githubusercontent.com, github.io
- **CDN comunes**: gstatic.com, googleapis.com, googleusercontent.com, ggpht.com, cloudflare.com, cdnjs.cloudflare.com, akamaihd.net, akamaized.net, cloudfront.net, amazonaws.com
- **Educación Madrid**: nce.wedu.comunidad.madrid, max.educa.madrid.org, educa.madrid.org
- **Ubuntu**: ubuntu.com (covers archive, security, packages subdomains)
- **Anthropic**: anthropic.com, claude.ai
- **Conectividad**: detectportal.firefox.com, connectivity-check.ubuntu.com

**Note**: URLs like `www.google.com`, `api.google.com`, `gist.githubusercontent.com` are NOT needed separately - they're automatically covered by the base domain.

## Testing and Debugging Commands

```bash
# View system status
sudo systemctl status dnsmasq-whitelist.timer
sudo systemctl status dnsmasq.service
sudo systemctl status captive-portal-detector.service

# View logs
sudo tail -f /var/log/url-whitelist.log
sudo tail -f /var/log/captive-portal-detector.log
sudo journalctl -u dnsmasq-whitelist.service -f
sudo journalctl -u captive-portal-detector.service -f

# Manual execution (for testing)
sudo /usr/local/bin/dnsmasq-whitelist.sh
sudo /usr/local/bin/captive-portal-detector.sh  # Run once

# View firewall rules
sudo iptables -L OUTPUT -n -v

# View whitelisted IPs (if ipset is supported)
sudo ipset list url_whitelist

# View current whitelist
cat /var/lib/url-whitelist/whitelist.txt

# View dnsmasq configuration
cat /etc/dnsmasq.d/url-whitelist.conf

# Test DNS resolution (whitelisted domain)
dig @127.0.0.1 google.com
nslookup google.com 127.0.0.1

# Test DNS resolution (non-whitelisted domain - should return NXDOMAIN)
dig @127.0.0.1 facebook.com
nslookup facebook.com 127.0.0.1

# Check if captive portal is detected
curl -s http://detectportal.firefox.com/success.txt
# Should return "success" if authenticated, redirect/block if not

# Check which DNS server is being used
cat /etc/resolv.conf
# Should show: nameserver 127.0.0.1

# Check DNS detection
cat /var/lib/url-whitelist/original-dns.conf  # DNS saved during installation
cat /var/lib/url-whitelist/current-dns.cache  # Last detected DNS
nmcli dev show | grep DNS  # Current DNS according to NetworkManager

# Disable/Enable system
sudo systemctl disable --now dnsmasq-whitelist.timer
sudo systemctl enable --now dnsmasq-whitelist.timer

# Uninstall system (full rollback)
sudo ./rollback-dnsmasq-whitelist.sh

# Collect debug information
sudo ./collect_debug_info.sh
cat debug_info.txt

# Force firewall to permissive mode (emergency)
sudo iptables -F OUTPUT
sudo iptables -P OUTPUT ACCEPT
```

## Installation

### Basic Installation (Interactive)

```bash
sudo ./setup-dnsmasq-whitelist.sh
```

The installer will:
1. **Detect existing installation** (offers Reinstall/Repair/Cancel if found)
2. Detect network gateway and DNS servers (does NOT assume gateway=DNS)
3. **Verify internet connectivity** (detects captive portals, offers offline mode)
4. **Prompt for whitelist URL** (default: LasEncinasIT Informática 3)
5. **Permanently disable** systemd-resolved and free port 53
6. Install dependencies (iptables, iptables-persistent, dnsutils, curl, dnsmasq)
7. Create backup of all configuration files (preserving symlinks)
8. Create captive portal detector script and service
9. Create whitelist manager script (with configured URL)
10. Configure dnsmasq to use detected primary DNS server
11. Set system DNS to localhost (preserving symlinks)
12. Create systemd services and timer
13. Download whitelist from configured URL (or use offline mode with BASE_URLS only)
14. **Validate dnsmasq functionality** (DNS resolution test)
15. Configure firewall ONLY if dnsmasq validation passes
16. Start captive portal detector service

### Automated Installation (Non-Interactive)

```bash
sudo ./setup-dnsmasq-whitelist.sh --whitelist-url "https://your-url.com/whitelist.txt"
```

This skips the URL prompt and uses the provided URL directly. Useful for scripted deployments.

### Installation Options

**If existing installation detected:**
- **Option 1: REINSTALAR** - Runs rollback script, then fresh install
- **Option 2: REPARAR** - Overwrites config files, keeps existing setup
- **Option 3: CANCELAR** - Exit without changes

**During connectivity check:**
- If authenticated: Normal installation with whitelist download
- If captive portal detected: Can choose offline mode (only BASE_URLS)

### Default Whitelist URL

The default institutional whitelist is:
```
https://raw.githubusercontent.com/LasEncinasIT/Whitelist-por-aula/refs/heads/main/Informatica%203.txt
```

Press Enter at the URL prompt to use this default.

## Modification Guidelines

### Adding URLs to Hardcoded Whitelist

Edit the `BASE_URLS` array in the embedded script (setup-dnsmasq-whitelist.sh:108-121):
```bash
BASE_URLS=(
    "google.es"
    "newdomain.com"  # Add new domains here
)
```

### Changing Whitelist URL

Modify the `WHITELIST_URL` variable (setup-dnsmasq-whitelist.sh:99):
```bash
WHITELIST_URL="https://your-new-url.com/whitelist.txt"
```

### Changing Update Frequency

Edit the timer configuration (setup-dnsmasq-whitelist.sh:426-434):
```bash
OnUnitActiveSec=5min  # Change to desired interval
```

### Fail-Open vs Fail-Closed Behavior

Current behavior is fail-open (setup-dnsmasq-whitelist.sh:344-347). To change to fail-closed, modify the `cleanup_firewall()` function to maintain restrictions instead of removing them.

### Remote Emergency Disable

The system supports remote emergency disabling via a keyword in the whitelist file:

**How it works:**
- The `check_emergency_disable()` function (lines 301-315) checks the first non-empty line of the downloaded whitelist
- If the line contains `# DESACTIVADO` (case-insensitive), the system enters fail-open mode
- This is checked after every successful whitelist download, before applying configurations

**Implementation details:**
```bash
# Function detects variations like:
# DESACTIVADO
# desactivado
# Sistema desactivado
# DESACTIVADO temporalmente
```

**Activation flow:**
1. Download whitelist from GitHub Gist (line 320)
2. Check for emergency disable keyword (line 322)
3. If detected, execute `cleanup_firewall()` and exit (lines 323-326)
4. If not detected, proceed with normal configuration (line 329)

**Use cases:**
- Emergency internet access during incidents
- Temporary unrestricted access for special events
- Simultaneous disable across all systems without physical access
- Quick rollback if whitelist causes issues

**To implement:**
Add `# DESACTIVADO` as the first line of the whitelist file in the GitHub Gist. Within 5 minutes (or immediately if manually executed), all systems will remove restrictions.

**To restore:**
Remove the `# DESACTIVADO` line from the Gist. Systems will re-enable restrictions on next update cycle.

## Security Considerations

- The system uses iptables OUTPUT chain filtering, which affects all system users
- CAP_NET_ADMIN capability is granted to dnsmasq to allow ipset modifications (if ipset is supported)
- **systemd-resolved is permanently disabled** to free port 53 for dnsmasq
- Detected primary DNS server is used as upstream (not necessarily the gateway)
- All DNS traffic goes through localhost dnsmasq instance
- **Firewall blocks VPN, Tor, and alternate DNS servers** (anti-bypass measures)
- **HTTP/HTTPS allowed to any IP** (trusts DNS sinkhole for blocking)
- Captive portal detector automatically disables firewall when behind login portal

## Architecture Evolution

### v3.3 Changes (2025-10-30) - CURRENT VERSION

v3.3 introduces **idempotent installation**, **interactive URL configuration**, **offline mode**, and **improved DNS detection** to support dynamic network environments.

**Key Changes in v3.3:**

1. **Idempotent Installation System**:
   - **Problem in v3.0-v3.2**: Running installer on existing installation would fail or create conflicts
   - **Solution**: Detects existing installation and offers 3 options:
     - **Reinstalar**: Runs rollback script automatically, then performs fresh install
     - **Reparar**: Overwrites configuration files while keeping existing structure
     - **Cancelar**: Exit without changes
   - **Benefit**: Safe to re-run installer, supports repair workflows

2. **Interactive URL Configuration**:
   - **Problem in v3.0-v3.2**: URL hardcoded in installer, required editing code to change
   - **Solution**: Prompts user during installation for whitelist URL
   - **Default**: LasEncinasIT institutional repository (Informática 3)
   - **Fallback**: If custom URL fails validation, uses default
   - **Command-line support**: `--whitelist-url "https://..."` for automated deployments

3. **Offline Installation Mode**:
   - **Problem**: Installation would fail if behind captive portal or GitHub unreachable
   - **Solution**: Detects captive portal using http://detectportal.firefox.com/success.txt
   - **Offers offline mode**: Installs with only hardcoded BASE_URLS, timer downloads whitelist later
   - **Benefit**: System can be deployed even without authenticated network access

4. **5-Method Dynamic DNS Detection** (Enhanced from v3.1):
   - **Priority 1**: DNS from previous installation (most reliable for re-installs)
   - **Priority 2**: NetworkManager detection (best for DHCP networks)
   - **Priority 3**: systemd-resolved (if active and not corrupted)
   - **Priority 4**: /etc/resolv.conf parsing
   - **Priority 5**: Test gateway as DNS
   - **Fallback**: Google DNS (8.8.8.8)
   - **Validation**: Each DNS server is tested with actual query before use
   - **Critical fix**: Does NOT assume gateway = DNS (common mistake that broke v3.0 on many networks)

5. **Domain Deduplication**:
   - **Optimization**: Removes redundant subdomains from whitelist
   - **Example**: If `google.com` exists, removes `www.google.com`, `api.google.com`, etc.
   - **Reason**: dnsmasq automatically resolves all subdomains of base domain
   - **Benefit**: Smaller config file, faster dnsmasq startup

6. **Enhanced Failed Installation Cleanup**:
   - **New function**: `cleanup_failed_installation()` (lines 430-510)
   - **Automated rollback**: If any validation fails during install, automatically:
     - Stops dnsmasq
     - Re-enables systemd-resolved
     - Restores original /etc/resolv.conf
     - Verifies internet connectivity
     - Provides emergency DNS fallback if no backup exists
   - **Benefit**: Installation failures never leave system without internet

7. **Improved Captive Portal Integration**:
   - **60-second boot delay**: Waits for network to stabilize before activating firewall
   - **Dynamic DNS in detector**: Captive portal detector also uses 3-method DNS detection
   - **Fail-safe**: If DNS detection fails in detector, uses emergency DNS

8. **Debug Collection Script**:
   - **New utility**: `collect_debug_info.sh`
   - **Purpose**: Collects all relevant system info for troubleshooting
   - **Output**: Single `debug_info.txt` file with:
     - System information
     - Service status (dnsmasq, timer, detector)
     - Network configuration
     - Firewall rules
     - dnsmasq configuration
     - Log files
     - DNS resolution tests
   - **Usage**: `sudo ./collect_debug_info.sh`
   - **Benefit**: Easy to share complete system state for support

**Installation Flow v3.3:**

```
[Existing installation check]
→ Detected → Offer Reinstall/Repair/Cancel
→ Not detected → Continue

[Connectivity check]
→ Check detectportal.firefox.com
→ Authenticated → Normal install
→ Captive portal → Offer offline mode

[URL configuration]
→ Show default (LasEncinasIT)
→ Prompt: Use default? (Y/n)
→ If n: Request custom URL → Validate → Use or fallback

[DNS detection - 5 methods]
→ Previous install DNS → Validate → Use if works
→ NetworkManager → Validate → Use if works
→ systemd-resolved → Validate → Use if works
→ /etc/resolv.conf → Validate → Use if works
→ Gateway → Validate → Use if works
→ Fallback → Google DNS (8.8.8.8)

[Installation with validation]
→ Create scripts with detected DNS and URL
→ Configure dnsmasq
→ Validate dnsmasq (10 attempts, 2s delay)
→ Download whitelist (or use BASE_URLS in offline mode)
→ Re-validate dnsmasq
→ ONLY THEN change system DNS to localhost
→ Final validation test
→ If ANY step fails → cleanup_failed_installation()
```

**Problems Solved by v3.3:**
- ✅ Safe to re-run installer (idempotent)
- ✅ No code editing needed to change URL
- ✅ Clear institutional default (LasEncinasIT)
- ✅ Works behind captive portals
- ✅ Works with any network DNS configuration
- ✅ Auto-detects DNS on every network change
- ✅ Never leaves system broken (auto-rollback)
- ✅ Easy troubleshooting (debug script)
- ✅ Supports automated deployments
- ✅ Optimized config (domain deduplication)

**Use Cases:**
- **Standard deployment**: Run installer, press Enter, use LasEncinasIT default
- **Custom whitelist**: Run installer, provide custom URL when prompted
- **Automated deployment**: Use `--whitelist-url` for scripted installations
- **Behind WEDU portal**: Choose offline mode, authenticate later, timer will sync
- **Repair broken install**: Run installer again, choose "Reparar"
- **Clean re-install**: Run installer again, choose "Reinstalar"
- **Mobile devices**: System auto-detects DNS changes when moving networks
- **Troubleshooting**: Run `collect_debug_info.sh`, share `debug_info.txt`

---

## Architecture v2.0 Corrections (2025-10-25)

The v2.0 architecture had critical flaws that allowed bypass of the whitelist. The following corrections were implemented:

### Critical Bugs Fixed in v2.0

1. **DNS Sinkhole Incomplete**
   - **Problem:** Configuration only defined `server=/domain/gateway` for whitelisted domains but didn't block non-whitelisted domains
   - **Impact:** Non-whitelisted domains could potentially resolve via root hints or other methods
   - **Fix:** Added `address=/#/127.0.0.1` to explicitly block all non-whitelisted domains (setup-dnsmasq-whitelist.sh:394-398)

2. **Firewall Allowed HTTP/HTTPS to ANY IP (CRITICAL)**
   - **Problem:** Firewall rules permitted HTTP/HTTPS to any destination without validation
   ```bash
   # BEFORE (INSECURE):
   iptables -A OUTPUT -p tcp --dport 80 -j ACCEPT
   iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT
   ```
   - **Impact:** Users could access any website if they had cached IPs or used direct IP access
   - **Fix:** Added ipset validation to firewall rules (setup-dnsmasq-whitelist.sh:170-173)
   ```bash
   # AFTER (SECURE):
   iptables -A OUTPUT -p tcp --dport 80 -m set --match-set url_whitelist dst -j ACCEPT
   iptables -A OUTPUT -p tcp --dport 443 -m set --match-set url_whitelist dst -j ACCEPT
   ```

3. **Missing ipset Implementation**
   - **Problem:** v2.0 removed ipset completely, relying only on DNS filtering
   - **Impact:** No IP-level validation, easy to bypass with cached IPs
   - **Fix:** Reintroduced ipset with automatic population via dnsmasq (setup-dnsmasq-whitelist.sh:386-390, 422-451)

4. **Rollback Script Could Brick Network**
   - **Problem:** `set -e` caused abrupt exits, wrong order of operations could leave system without DNS
   - **Impact:** Running rollback could leave machines without internet
   - **Fix:** Removed `set -e`, improved operation order, added validation and emergency DNS fallback (rollback-dnsmasq-whitelist.sh)

### How v2.0 Now Works (Corrected Architecture)

**Three-Layer Defense:**

1. **Layer 1: DNS Sinkhole (dnsmasq)**
   - Whitelisted domains: `server=/domain/gateway` + `ipset=/domain/url_whitelist`
   - Non-whitelisted domains: `address=/#/127.0.0.1` (blocked)
   - dnsmasq automatically adds resolved IPs to ipset in real-time

2. **Layer 2: IP Validation (ipset)**
   - ipset `url_whitelist` maintains list of allowed IPs
   - Pre-populated with base domains on startup
   - Automatically updated by dnsmasq as domains are resolved

3. **Layer 3: Firewall (iptables)**
   - Blocks DNS queries to non-localhost servers
   - Blocks VPN ports (OpenVPN, WireGuard, PPTP)
   - Blocks Tor ports
   - **Allows HTTP/HTTPS ONLY to IPs in ipset** (critical fix)
   - Blocks direct IP access (except private networks)

**Captive Portal Detection:**
- `captive-portal-detector.sh` monitors network authentication status
- When NOT authenticated (e.g., WEDU login required): firewall disabled (permissive mode)
- When authenticated: firewall enabled (restrictive mode with whitelist)
- Checks every 30 seconds using http://detectportal.firefox.com/success.txt

**Bypass Prevention:**
- DNS bypass: Blocked via iptables (only localhost DNS allowed)
- Cached IP bypass: Blocked via ipset validation in firewall
- Direct IP bypass: Blocked via iptables (HTTP/HTTPS requires ipset match)
- VPN bypass: Blocked via iptables (common VPN ports dropped)
- Proxy bypass: Prevented by DNS+IP validation
- /etc/hosts bypass: Prevented by DNS+IP validation

### Rollback Script Improvements

**Before (Dangerous):**
- `set -e` caused abrupt exits on errors
- Could leave system without DNS if operations failed mid-execution
- No validation of restored configuration

**After (Safe):**
- Explicit error handling (no `set -e`)
- Correct operation order: systemd-resolved → dnsmasq → resolv.conf → validation
- Validates DNS functionality after restoration
- Emergency DNS fallback to 8.8.8.8 if restoration fails
- Reports connectivity status to user

## Known Issues Fixed (2025-01-24)

### Critical Bugs Resolved

1. **Hardcoded Gist URL with Commit Hash**
   - **Problem:** URL contained commit hash, breaking remote updates
   - **Impact:** Systems continued using old whitelist version after edits
   - **Fix:** Removed hash to always fetch latest version

2. **Complete Internet Loss During Installation**
   - **Problem:** Port 53 not freed before dnsmasq installation + firewall activated before validating DNS
   - **Impact:** System left without internet connectivity
   - **Fix:**
     - Stop systemd-resolved BEFORE apt install
     - Validate dnsmasq functionality BEFORE activating firewall
     - Fail-safe: never activate firewall if DNS doesn't work

3. **iptables Rule Count Bug**
   - **Problem:** `grep -c` with `|| echo "0"` returned `"0\n0"`, causing bash integer comparison error
   - **Impact:** Script error during execution
   - **Fix:** Use `wc -l` with explicit integer validation

4. **No Configuration Backups**
   - **Problem:** Rollback script expected backups that were never created
   - **Impact:** Rollback couldn't restore original configuration
   - **Fix:** Create backups of all modified system files before changes

5. **Aggressive Error Handling**
   - **Problem:** `set -e` caused script to exit on any error, leaving system in inconsistent state
   - **Impact:** Partial configuration with broken state
   - **Fix:** Removed `set -e`, added explicit error handling with fail-safe behavior

### Installation Flow Improvements

**Before (Broken):**
1. Install dnsmasq → FAILS (port 53 busy)
2. Configure firewall → Blocks everything
3. Restart dnsmasq → May fail silently
4. **Result:** No internet

**After (Safe):**
1. Stop systemd-resolved
2. Verify port 53 free
3. Install dnsmasq (without auto-start)
4. Generate configuration
5. Restart and VALIDATE dnsmasq
6. ONLY IF validation passes → Configure firewall
7. **Result:** Either working whitelist or fail-open (full access)

## Known Issues Fixed (2025-10-27)

### Critical Bugs Resolved

During extensive testing and debugging, 6 critical bugs were discovered that could cause complete network connectivity loss during installation:

1. **Symlink Destruction in /etc/resolv.conf**
   - **Problem:** Using `cat > /etc/resolv.conf` destroyed the symlink to `/run/systemd/resolve/stub-resolv.conf`
   - **Impact:** System DNS configuration permanently corrupted, breaking systemd-resolved integration
   - **Fix:** Created `write_resolv_conf()` function that preserves symlinks by detecting symlink type and writing to the target file instead
   ```bash
   # Before (BROKEN):
   cat > /etc/resolv.conf << EOF
   nameserver 127.0.0.1
   EOF

   # After (SAFE):
   write_resolv_conf() {
       if [ -L /etc/resolv.conf ]; then
           local target=$(readlink -f /etc/resolv.conf)
           echo "$1" > "$target"  # Write to target, preserve symlink
       else
           echo "$1" > /etc/resolv.conf
       fi
   }
   ```

2. **No Captive Portal Detection Before Installation**
   - **Problem:** Installation proceeded even when system was behind captive portal requiring authentication
   - **Impact:** Installation failed when trying to download packages or whitelist, potentially leaving system in broken state
   - **Fix:** Added `check_internet_connectivity()` function that tests http://detectportal.firefox.com/success.txt before proceeding
   ```bash
   check_internet_connectivity() {
       if timeout 10 curl -s http://detectportal.firefox.com/success.txt 2>/dev/null | grep -q "success"; then
           return 0  # Full internet access
       fi
       # Detect captive portal and offer offline mode...
   }
   ```

3. **Backup Without Preserving Symlink Type**
   - **Problem:** Backup used `cp /etc/resolv.conf /etc/resolv.conf.backup-whitelist` which copied content, not symlink type
   - **Impact:** Rollback script couldn't restore original symlink, only file content
   - **Fix:** Detect symlink type and save symlink target separately
   ```bash
   if [ -L /etc/resolv.conf ]; then
       readlink /etc/resolv.conf > /etc/resolv.conf.backup-whitelist.symlink
   else
       cp /etc/resolv.conf /etc/resolv.conf.backup-whitelist
   fi
   ```

4. **Dangerous Operation Order: DNS Changed Before Validation**
   - **Problem:** Script changed `/etc/resolv.conf` to use localhost (127.0.0.1) BEFORE validating that dnsmasq was working
   - **Impact:** If dnsmasq failed to start or bind to port 53, system was left without DNS resolution
   - **Fix:** Reordered operations to validate dnsmasq FIRST, then change system DNS ONLY after successful validation
   ```bash
   # Before (DANGEROUS):
   # 1. Change /etc/resolv.conf → nameserver 127.0.0.1
   # 2. Restart dnsmasq
   # 3. Validate dnsmasq (but DNS already broken if this fails)

   # After (SAFE):
   # 1. Generate dnsmasq configuration
   # 2. Restart dnsmasq
   # 3. Validate dnsmasq is working
   # 4. ONLY if validation passes → Change /etc/resolv.conf
   ```

5. **Gateway ≠ DNS Server Critical Assumption**
   - **Problem:** Script assumed gateway (10.112.248.1) was the DNS server and configured dnsmasq to use it as upstream
   - **Impact:** dnsmasq could not resolve ANY domains because gateway doesn't respond to DNS queries (real DNS was 172.23.136.5)
   - **Fix:** Added DNS server auto-detection from systemd-resolved's configuration
   ```bash
   # Detect real DNS servers from systemd-resolved
   if [ -f /run/systemd/resolve/resolv.conf ]; then
       DNS_SERVERS=$(grep "^nameserver" /run/systemd/resolve/resolv.conf | \
                     awk '{print $2}' | grep -v "^127\." | head -3)
   fi
   PRIMARY_DNS=$(echo "$DNS_SERVERS" | cut -d',' -f1)

   # Use PRIMARY_DNS instead of GATEWAY_IP in dnsmasq configuration
   server=/google.com/$PRIMARY_DNS  # Not gateway!
   ```

6. **Incorrect Port 53 Validation Regex**
   - **Problem:** Regex pattern `"dnsmasq.*:53 "` (with trailing space) didn't match actual `ss` output format
   - **Impact:** Validation incorrectly reported dnsmasq wasn't listening on port 53, triggering fail-safe mode unnecessarily
   - **Fix:** Corrected regex pattern to match actual ss output
   ```bash
   # Before (BROKEN):
   if ! ss -tulpn 2>/dev/null | grep -E "dnsmasq.*(:|=)53\s"; then

   # After (WORKING):
   if ! ss -tulpn 2>/dev/null | grep -q "dnsmasq.*:53"; then
   ```

### Testing and Validation Methodology

To verify the fixes, a comprehensive testing suite was developed:

```bash
# 1. DNS Resolution Test (Whitelisted)
echo "=== TEST 1: DNS Resolution (Whitelisted) ==="
dig @127.0.0.1 anthropic.com +short +time=3

# 2. DNS Sinkhole Test (Blocked)
echo "=== TEST 2: DNS Sinkhole (Blocked) ==="
dig @127.0.0.1 twitter.com +short +time=3
# Expected: 127.0.0.1

# 3. Internet Connectivity Test
echo "=== TEST 3: Internet Connectivity ==="
timeout 10 curl -I https://www.anthropic.com 2>&1 | head -1

# 4. Symlink Preservation Test
echo "=== TEST 4: Symlink Preservation ==="
ls -la /etc/resolv.conf
# Expected: lrwxrwxrwx ... → /run/systemd/resolve/stub-resolv.conf

# 5. Service Status Test
echo "=== TEST 5: Service Status ==="
systemctl is-active dnsmasq
systemctl is-active dnsmasq-whitelist.timer
systemctl is-active captive-portal-detector.timer

# 6. Firewall and ipset Test
echo "=== TEST 6: Firewall and ipset ==="
sudo iptables -L OUTPUT -n | grep -c "url_whitelist"
sudo ipset list url_whitelist | head -10
```

### Installation Flow with All Fixes Applied

**Current Safe Flow:**

1. **Pre-flight Checks**
   - Check for captive portal via detectportal.firefox.com
   - Offer offline mode if no internet
   - Verify sudo access

2. **DNS Server Detection**
   - Read `/run/systemd/resolve/resolv.conf` to find real DNS servers
   - Extract PRIMARY_DNS (e.g., 172.23.136.5), not gateway
   - Fallback to gateway only if no DNS found

3. **Port 53 Liberation**
   - Stop systemd-resolved
   - Verify port 53 is free (10-second timeout)
   - Prevent "address already in use" errors

4. **Backup with Symlink Preservation**
   - Detect if `/etc/resolv.conf` is symlink
   - Save symlink target separately (.backup-whitelist.symlink)
   - Save file content for regular files (.backup-whitelist)

5. **Package Installation**
   - Install dnsmasq, ipset, iptables (without auto-start)
   - Configure dnsmasq with correct upstream DNS (PRIMARY_DNS)

6. **Critical Validation Before DNS Change**
   - Generate dnsmasq configuration
   - Restart dnsmasq service
   - Wait for service to be fully active
   - Validate port 53 binding with correct regex
   - Test DNS resolution functionality
   - **IF ANY VALIDATION FAILS → Abort and trigger fail-safe**

7. **Safe DNS Switch (Only After Validation)**
   - Use `write_resolv_conf()` to preserve symlinks
   - Change nameserver to 127.0.0.1
   - System DNS now points to validated, working dnsmasq

8. **Firewall Configuration**
   - Create ipset `url_whitelist`
   - Pre-populate with base domains using PRIMARY_DNS
   - Configure iptables rules
   - Enable systemd timer for periodic updates

**Result:** Either fully functional whitelist OR fail-open (no restrictions), never broken connectivity.

### Debugging Session Insights

**Key Discoveries:**

1. **Gateway vs DNS Server Distinction**
   - Network gateway (default route): 10.112.248.1
   - Actual DNS server: 172.23.136.5
   - These are often different in institutional networks (schools, universities, enterprises)

2. **Symlink Importance**
   - Ubuntu uses `/etc/resolv.conf` → `/run/systemd/resolve/stub-resolv.conf` symlink
   - systemd-resolved dynamically manages the target file
   - Breaking the symlink breaks integration with systemd-resolved

3. **Validation Timing**
   - Must validate BEFORE changing system configuration
   - Fail-safe principle: never leave system in worse state than before
   - Always provide rollback path

4. **Captive Portal Awareness**
   - Many institutional networks require web authentication before allowing internet
   - Installation must detect and handle this gracefully
   - Offline mode allows manual whitelist provision

### Related Files Modified

- **setup-dnsmasq-whitelist.sh**: Applied all 6 bug fixes (lines 43-94, 88-102, 139, 547-564, 619, 721, 789, 917-928)
- **rollback-dnsmasq-whitelist.sh**: Improved symlink restoration (lines 251-278)
- **/etc/dnsmasq.d/url-whitelist.conf**: Updated to use real DNS server (172.23.136.5 instead of gateway)

## Known Issues Fixed (2025-10-30)

### Critical Bug Resolved: Bug #13 - systemd Override Ineffective

During deployment testing on multiple machines, a critical bug was discovered where dnsmasq would start but fail to resolve DNS queries.

#### **Bug #13: systemd Override Not Preventing Init Script Interference**

**Problem:**
The systemd override configuration was not fully preventing Ubuntu's dnsmasq init script from adding unwanted parameters. Specifically:

- Expected: `/usr/sbin/dnsmasq -k --conf-file=/etc/dnsmasq.conf`
- Actual: `/usr/sbin/dnsmasq -x /run/dnsmasq/dnsmasq.pid -u dnsmasq -r /run/dnsmasq/resolv.conf`

The `-r /run/dnsmasq/resolv.conf` parameter instructed dnsmasq to read upstream DNS servers from a file that didn't exist or was empty, causing:
```
dnsmasq[3779]: no se encontraron servidores en /run/dnsmasq/resolv.conf, se reintentará
```

**Impact:**
- dnsmasq started successfully (service active)
- dnsmasq listened on port 53 correctly
- **DNS resolution FAILED** - no upstream servers configured
- Installation aborted with all validations failing

**Root Cause:**
The Ubuntu `dnsmasq` package includes init scripts that wrap the systemd service, modifying ExecStart parameters even when an override is present. The override was missing critical flags and environment variables to prevent this interference.

**Fix Applied (Lines 1469-1497):**

```bash
# Enhanced systemd override with full isolation
cat > /etc/systemd/system/dnsmasq.service.d/override.conf << 'OVERRIDE_EOF'
[Service]
Type=simple
PIDFile=

# CRITICAL: Double ExecStart= line (empty + command)
ExecStart=
ExecStart=/usr/sbin/dnsmasq -k --conf-file=/etc/dnsmasq.conf --no-resolv

# Disable all wrapper scripts
ExecStartPre=
ExecStartPost=
ExecStop=

# Prevent init script interference
Environment="IGNORE_RESOLVCONF=yes"

# Explicit logging
StandardOutput=journal
StandardError=journal
OVERRIDE_EOF
```

**Key Changes:**
1. Added `--no-resolv` flag to explicitly ignore any external resolv.conf files
2. Added `Environment="IGNORE_RESOLVCONF=yes"` to prevent resolvconf hook interference
3. Added explicit journal logging directives
4. Improved documentation of the double `ExecStart=` pattern requirement

**Validation Added (Lines 1630-1653):**

Added post-start validation to detect if dnsmasq is using incorrect parameters:

```bash
# Verify dnsmasq is using our parameters (not init script's)
if ps aux | grep -E 'dnsmasq.*-k.*--conf-file=/etc/dnsmasq.conf' | grep -v grep; then
    echo "✓ dnsmasq using correct parameters"
else
    echo "✗ ERROR: dnsmasq NOT using our parameters"
    # Show actual parameters and abort
fi
```

**Testing Evidence:**

Before fix (portatil29):
```
oct 30 11:04:09 dnsmasq[3779]: no se encontraron servidores en /run/dnsmasq/resolv.conf
✗ dnsmasq no puede resolver DNS (10/10 attempts failed)
```

After fix (expected):
```
dnsmasq[xxxx]: se usa el servidor 172.23.136.5#53
✓ dnsmasq resuelve DNS correctamente
```

### Why systemd Overrides Can Fail

**Important systemd Behavior:**
- A single `ExecStart=` line **APPENDS** to the inherited value
- You **MUST** use TWO lines:
  1. `ExecStart=` (empty - clears inherited value)
  2. `ExecStart=/command` (sets new value)
- Without the empty line, both commands run

**Additional Protections Needed:**
- Clear `ExecStartPre=`, `ExecStartPost=`, `ExecStop=` to disable hooks
- Use `Environment=` variables to signal wrapper scripts to skip modifications
- Add explicit validation after service start to detect override failures

### Related Files Modified

- **setup-dnsmasq-whitelist.sh**: Bug #13 fix applied (lines 1469-1497, 1630-1653)
- **CLAUDE.md**: This documentation (lines 566-end)
