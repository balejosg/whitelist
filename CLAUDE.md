# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository contains a **dnsmasq-based URL whitelist system** for Ubuntu/Debian systems. It provides internet access control by allowing only whitelisted domains while blocking all other traffic. The system is designed with a "fail-open" approach: if the whitelist server is unreachable, no restrictions are applied.

## System Architecture

### Core Components

1. **Installation Script** (`setup-dnsmasq-whitelist.sh`):
   - One-time setup script that installs and configures the entire system
   - Must be run as root/sudo
   - Detects network gateway automatically
   - Installs dependencies (ipset, iptables, dnsmasq, curl)
   - Creates the main whitelist manager script and systemd services

2. **Whitelist Manager** (`/usr/local/bin/dnsmasq-whitelist.sh`):
   - Auto-generated by the installer (lines 87-354)
   - Downloads whitelist from GitHub Gist (https://gist.githubusercontent.com/balejosg/9a81340e7e7bfd044cc031f41af6acdc/raw/0b0a2339e8eb513dde8197cdc3eab487abd5f3cf/whitelist.txt)
   - Generates dnsmasq configuration from whitelist
   - Configures iptables rules and ipset
   - Runs every 5 minutes via systemd timer

3. **dnsmasq DNS Server**:
   - Listens on localhost (127.0.0.1)
   - Resolves DNS queries and automatically adds resolved IPs to ipset
   - Uses router as upstream DNS server
   - Configured via `/etc/dnsmasq.conf` and `/etc/dnsmasq.d/url-whitelist.conf`

4. **Firewall (iptables + ipset)**:
   - Uses OUTPUT chain to filter outgoing traffic
   - ipset name: `url_whitelist`
   - Allows: localhost, established connections, DNS queries, and whitelisted IPs
   - Drops all other traffic

### Key Design Decisions

- **Dynamic IP Resolution**: Uses dnsmasq + ipset to solve the dynamic IP problem. When dnsmasq resolves a whitelisted domain, it automatically adds the IP to ipset in real-time.
- **Fail-Open Strategy**: If the GitHub Gist whitelist cannot be downloaded, the system removes all firewall restrictions to avoid blocking legitimate access.
- **Remote Emergency Disable**: The system can be remotely disabled by adding `# DESACTIVADO` as the first non-empty line in the whitelist file. This triggers fail-open mode across all systems simultaneously.
- **System-Wide Application**: Applies to all users on the system.
- **5-Minute Update Cycle**: Whitelist is re-downloaded every 5 minutes via systemd timer.

## File Locations

- **Installation script**: `setup-dnsmasq-whitelist.sh` (in repository root)
- **Runtime script**: `/usr/local/bin/dnsmasq-whitelist.sh` (generated during install)
- **Whitelist file**: `/var/lib/url-whitelist/whitelist.txt`
- **dnsmasq config**: `/etc/dnsmasq.d/url-whitelist.conf`
- **Logs**: `/var/log/url-whitelist.log`
- **systemd service**: `/etc/systemd/system/dnsmasq-whitelist.service`
- **systemd timer**: `/etc/systemd/system/dnsmasq-whitelist.timer`

## Hardcoded Base URLs

The system includes hardcoded base URLs (lines 108-121) that are always whitelisted:
- google.es (for basic web access)
- github.com, gist.githubusercontent.com (for whitelist download)
- nce.wedu.comunidad.madrid, max.educa.madrid.org (education sites)
- archive.ubuntu.com, security.ubuntu.com (system updates)
- anthropic.com, claude.ai (Claude AI access)
- deb.nodesource.com (Node.js packages)

## Testing and Debugging Commands

```bash
# View system status
sudo systemctl status dnsmasq-whitelist.timer
sudo systemctl status dnsmasq.service

# View logs
sudo tail -f /var/log/url-whitelist.log
sudo journalctl -u dnsmasq-whitelist.service -f

# Manual execution (for testing)
sudo /usr/local/bin/dnsmasq-whitelist.sh

# View firewall rules
sudo iptables -L OUTPUT -n -v

# View whitelisted IPs
sudo ipset list url_whitelist

# View current whitelist
cat /var/lib/url-whitelist/whitelist.txt

# View dnsmasq configuration
cat /etc/dnsmasq.d/url-whitelist.conf

# Test DNS resolution
nslookup example.com 127.0.0.1
dig @127.0.0.1 example.com

# Disable/Enable system
sudo systemctl disable --now dnsmasq-whitelist.timer
sudo systemctl enable --now dnsmasq-whitelist.timer
```

## Installation

```bash
sudo ./setup-dnsmasq-whitelist.sh
```

The installer will:
1. Install dependencies
2. Configure dnsmasq with CAP_NET_ADMIN capability
3. Configure systemd-resolved to free port 53
4. Create the whitelist manager script
5. Configure dnsmasq to use router as upstream DNS
6. Set system DNS to localhost
7. Create systemd service and timer
8. Perform initial whitelist download and system configuration

## Modification Guidelines

### Adding URLs to Hardcoded Whitelist

Edit the `BASE_URLS` array in the embedded script (setup-dnsmasq-whitelist.sh:108-121):
```bash
BASE_URLS=(
    "google.es"
    "newdomain.com"  # Add new domains here
)
```

### Changing Whitelist URL

Modify the `WHITELIST_URL` variable (setup-dnsmasq-whitelist.sh:99):
```bash
WHITELIST_URL="https://your-new-url.com/whitelist.txt"
```

### Changing Update Frequency

Edit the timer configuration (setup-dnsmasq-whitelist.sh:426-434):
```bash
OnUnitActiveSec=5min  # Change to desired interval
```

### Fail-Open vs Fail-Closed Behavior

Current behavior is fail-open (setup-dnsmasq-whitelist.sh:344-347). To change to fail-closed, modify the `cleanup_firewall()` function to maintain restrictions instead of removing them.

### Remote Emergency Disable

The system supports remote emergency disabling via a keyword in the whitelist file:

**How it works:**
- The `check_emergency_disable()` function (lines 301-315) checks the first non-empty line of the downloaded whitelist
- If the line contains `# DESACTIVADO` (case-insensitive), the system enters fail-open mode
- This is checked after every successful whitelist download, before applying configurations

**Implementation details:**
```bash
# Function detects variations like:
# DESACTIVADO
# desactivado
# Sistema desactivado
# DESACTIVADO temporalmente
```

**Activation flow:**
1. Download whitelist from GitHub Gist (line 320)
2. Check for emergency disable keyword (line 322)
3. If detected, execute `cleanup_firewall()` and exit (lines 323-326)
4. If not detected, proceed with normal configuration (line 329)

**Use cases:**
- Emergency internet access during incidents
- Temporary unrestricted access for special events
- Simultaneous disable across all systems without physical access
- Quick rollback if whitelist causes issues

**To implement:**
Add `# DESACTIVADO` as the first line of the whitelist file in the GitHub Gist. Within 5 minutes (or immediately if manually executed), all systems will remove restrictions.

**To restore:**
Remove the `# DESACTIVADO` line from the Gist. Systems will re-enable restrictions on next update cycle.

## Security Considerations

- The system uses iptables OUTPUT chain filtering, which affects all system users
- CAP_NET_ADMIN capability is granted to dnsmasq (line 64) to allow ipset modifications
- systemd-resolved is configured to use the router as upstream DNS
- All DNS traffic goes through localhost dnsmasq instance
